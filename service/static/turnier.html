<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Turnier Admin â€“ EarlySalty</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d2e;
  --surface2: #232640;
  --border: #2e3250;
  --accent: #6c63ff;
  --accent2: #ff6b6b;
  --green: #43e97b;
  --gold: #ffd700;
  --text: #e8eaf0;
  --muted: #8b90a7;
  --danger: #e74c3c;
  --success: #27ae60;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; }

/* Layout */
.topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
.topbar-title { font-size: 18px; font-weight: 700; color: var(--gold); display: flex; align-items: center; gap: 8px; }
.topbar-user { color: var(--muted); font-size: 13px; display: flex; align-items: center; gap: 12px; }
.topbar-user a { color: var(--accent); text-decoration: none; }
.container { max-width: 1300px; margin: 0 auto; padding: 20px; display: grid; gap: 20px; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 900px) { .grid2 { grid-template-columns: 1fr; } }

/* Cards */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 18px; }
.card-title { font-size: 15px; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
.card-title span.icon { font-size: 18px; }

/* Buttons */
.btn { padding: 7px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: opacity .15s; }
.btn:hover { opacity: .85; }
.btn:disabled { opacity: .4; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-muted { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-sm { padding: 4px 9px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

/* Badges */
.badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
.badge-green { background: rgba(67,233,123,.15); color: var(--green); border: 1px solid rgba(67,233,123,.3); }
.badge-red { background: rgba(231,76,60,.15); color: var(--danger); border: 1px solid rgba(231,76,60,.3); }
.badge-gold { background: rgba(255,215,0,.12); color: var(--gold); border: 1px solid rgba(255,215,0,.3); }
.badge-blue { background: rgba(108,99,255,.15); color: #8b8fff; border: 1px solid rgba(108,99,255,.3); }
.badge-muted { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }

/* Period info */
.period-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 14px; }
.period-stat { background: var(--surface2); border-radius: 8px; padding: 10px 14px; }
.period-stat-label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
.period-stat-value { font-size: 16px; font-weight: 700; margin-top: 4px; }

/* Table */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th { background: var(--surface2); padding: 9px 12px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); border-bottom: 1px solid var(--border); }
td { padding: 9px 12px; border-bottom: 1px solid rgba(255,255,255,.04); }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(255,255,255,.02); }
.empty-hint { color: var(--muted); text-align: center; padding: 24px; font-style: italic; }

/* Teams grid */
.teams-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
.team-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
.team-card-name { font-weight: 700; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.team-member { font-size: 12px; color: var(--muted); padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,.04); }
.team-member:last-child { border-bottom: none; }
.team-actions { margin-top: 8px; display: flex; gap: 6px; }

/* Bracket */
.bracket { display: flex; gap: 0; overflow-x: auto; padding: 10px 0; }
.bracket-round { display: flex; flex-direction: column; justify-content: space-around; min-width: 180px; position: relative; }
.bracket-round-label { text-align: center; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); margin-bottom: 12px; font-weight: 700; }
.bracket-match { display: flex; flex-direction: column; gap: 2px; margin: 8px; flex: 1; justify-content: center; }
.bracket-entry { background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 7px 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; cursor: default; transition: border-color .15s; }
.bracket-entry:hover { border-color: var(--accent); }
.bracket-entry.winner { border-color: var(--gold); background: rgba(255,215,0,.07); }
.bracket-entry.bye { opacity: .35; font-style: italic; }
.bracket-entry.tbd { opacity: .4; font-style: italic; }
.bracket-score { font-size: 10px; color: var(--muted); }
.bracket-divider { height: 1px; background: var(--border); margin: 2px 8px; }
.bracket-connector { width: 20px; display: flex; flex-direction: column; justify-content: center; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal-overlay.hidden { display: none; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; min-width: 360px; max-width: 500px; width: 95%; }
.modal-title { font-size: 16px; font-weight: 700; margin-bottom: 18px; }
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
.form-group input, .form-group select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 9px 12px; font-size: 14px; outline: none; transition: border-color .15s; }
.form-group input:focus, .form-group select:focus { border-color: var(--accent); }
.form-group input[type="datetime-local"] { color-scheme: dark; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
.alert { padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-bottom: 14px; }
.alert-error { background: rgba(231,76,60,.12); border: 1px solid rgba(231,76,60,.3); color: #ff7675; }
.alert-success { background: rgba(39,174,96,.12); border: 1px solid rgba(39,174,96,.3); color: var(--green); }

/* Status dot */
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
.dot-red { background: var(--danger); }
.dot-yellow { background: var(--gold); }
.dot-muted { background: var(--muted); }

/* Loading */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-wrap { display: flex; align-items: center; gap: 10px; color: var(--muted); padding: 20px; }

/* Pagination */
.pagination { display: flex; align-items: center; gap: 8px; margin-top: 12px; justify-content: flex-end; }
.pagination .btn-sm { min-width: 32px; }
.page-info { color: var(--muted); font-size: 12px; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">ğŸ† Turnier Admin</div>
  <div class="topbar-user">
    <span id="userLabel">{{AUTH_USER_LABEL}}</span>
    <a href="/admin">â† Dashboard</a>
    <a href="{{AUTH_LOGOUT_URL}}">Abmelden</a>
  </div>
</div>

<!-- Modals -->
<div id="modalPeriod" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">ğŸ“… Anmeldezeitraum erstellen</div>
    <div id="periodAlert" class="alert alert-error hidden"></div>
    <div class="form-group"><label>Name des Zeitraums</label><input id="pName" placeholder="z. B. Deadlock Cup #1 MÃ¤rz 2026"></div>
    <div class="form-group"><label>Anmeldebeginn</label><input id="pStart" type="datetime-local"></div>
    <div class="form-group"><label>Anmeldeschluss</label><input id="pEnd" type="datetime-local"></div>
    <div class="form-group"><label>Max. TeamgrÃ¶ÃŸe (Spieler pro Team)</label><input id="pTeamSize" type="number" min="2" max="20" value="6"></div>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modalPeriod')">Abbrechen</button>
      <button class="btn btn-primary" onclick="createPeriod()">Erstellen</button>
    </div>
  </div>
</div>

<div id="modalTeam" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">ğŸ›¡ï¸ Team erstellen</div>
    <div id="teamAlert" class="alert alert-error hidden"></div>
    <div class="form-group"><label>Teamname</label><input id="tName" placeholder="z. B. Team Alpha" maxlength="32"></div>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modalTeam')">Abbrechen</button>
      <button class="btn btn-primary" onclick="createTeam()">Erstellen</button>
    </div>
  </div>
</div>

<div id="modalConfirm" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title" id="confirmTitle">BestÃ¤tigen</div>
    <p id="confirmText" style="color:var(--muted);margin-bottom:20px;"></p>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modalConfirm')">Abbrechen</button>
      <button class="btn btn-danger" id="confirmOkBtn">Ja, fortfahren</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- Guild selector -->
  <div style="display:flex;align-items:center;gap:12px;">
    <label style="color:var(--muted);font-size:13px;">Server:</label>
    <select id="guildSelect" class="btn btn-muted" style="padding:6px 12px;" onchange="loadData()">
      <option value="">LÃ¤dtâ€¦</option>
    </select>
    <button class="btn btn-muted btn-sm" onclick="loadData()">â†º Aktualisieren</button>
  </div>

  <!-- Period Section -->
  <div class="card">
    <div class="card-title"><span class="icon">ğŸ“…</span> Anmeldezeitraum</div>
    <div id="periodContent">
      <div class="loading-wrap"><div class="spinner"></div> Lade Datenâ€¦</div>
    </div>
  </div>

  <!-- Signups + Teams -->
  <div class="grid2">
    <!-- Signups -->
    <div class="card" style="grid-column: 1 / -1;">
      <div class="card-title" style="justify-content: space-between;">
        <span><span class="icon">ğŸ“‹</span> Anmeldungen</span>
        <div style="display:flex;gap:8px;">
          <input id="signupSearch" placeholder="Suchenâ€¦" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:5px 10px;font-size:13px;outline:none;width:180px;" oninput="renderSignups()">
          <button class="btn btn-danger btn-sm" onclick="confirmClearSignups()">Alle lÃ¶schen</button>
        </div>
      </div>
      <div id="signupsContent">
        <div class="loading-wrap"><div class="spinner"></div> Ladeâ€¦</div>
      </div>
      <div class="pagination" id="signupPagination" style="display:none;"></div>
    </div>
  </div>

  <!-- Teams -->
  <div class="card">
    <div class="card-title" style="justify-content:space-between;">
      <span><span class="icon">ğŸ›¡ï¸</span> Teams</span>
      <button class="btn btn-primary btn-sm" onclick="openModal('modalTeam')">+ Team erstellen</button>
    </div>
    <div id="teamsContent">
      <div class="loading-wrap"><div class="spinner"></div> Ladeâ€¦</div>
    </div>
  </div>

  <!-- Bracket -->
  <div class="card" style="grid-column: 1 / -1;">
    <div class="card-title" style="justify-content:space-between;">
      <span><span class="icon">ğŸ†</span> Turnierbaum</span>
      <button class="btn btn-success btn-sm" onclick="loadBracket()">Bracket generieren</button>
    </div>
    <div id="bracketContent" style="color:var(--muted);font-style:italic;padding:16px;">
      Klicke â€Bracket generieren" um den aktuellen Turnierbaum zu erstellen.
    </div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let csrfToken = '';
let currentGuildId = '';
let allSignups = [];
let allTeams = [];
let signupPage = 0;
const PAGE_SIZE = 15;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const me = await apiGet('/api/auth/me');
    if (!me.authenticated) {
      window.location.href = '{{DISCORD_LOGIN_URL}}';
      return;
    }
    csrfToken = me.csrf_token || '';
    await loadData();
  } catch (e) {
    console.error('Init error:', e);
  }
}

// â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiGet(url) {
  const r = await fetch(url);
  if (r.status === 401) { window.location.href = '{{DISCORD_LOGIN_URL}}'; throw new Error('Unauthorized'); }
  if (!r.ok) throw new Error(`${r.status} ${await r.text()}`);
  return r.json();
}

async function apiPost(url, body) {
  const r = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
    body: JSON.stringify(body),
  });
  if (r.status === 401) { window.location.href = '{{DISCORD_LOGIN_URL}}'; throw new Error('Unauthorized'); }
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  const guildId = document.getElementById('guildSelect').value;
  const params = guildId ? `?guild_id=${guildId}` : '';
  try {
    const data = await apiGet(`/api/turnier/overview${params}`);
    populateGuildSelect(data.guilds, data.guild_id);
    currentGuildId = data.guild_id;
    allSignups = data.signups || [];
    allTeams = data.teams || [];
    renderPeriod(data.active_period, data.summary);
    signupPage = 0;
    renderSignups();
    renderTeams(allTeams, allSignups, data.active_period);
  } catch (e) {
    showError('Fehler beim Laden: ' + e.message);
  }
}

function populateGuildSelect(guilds, currentId) {
  const sel = document.getElementById('guildSelect');
  const prev = sel.value;
  sel.innerHTML = '';
  (guilds || []).forEach(g => {
    const o = document.createElement('option');
    o.value = g.id;
    o.textContent = `${g.name} (${g.signups} Anmeldungen)`;
    if (String(g.id) === String(currentId)) o.selected = true;
    sel.appendChild(o);
  });
  if (!sel.value && guilds && guilds.length) sel.value = guilds[0].id;
}

// â”€â”€ Period â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPeriod(period, summary) {
  const el = document.getElementById('periodContent');
  if (!period) {
    el.innerHTML = `
      <p style="color:var(--muted);margin-bottom:12px;">Kein aktiver Anmeldezeitraum.</p>
      <button class="btn btn-primary" onclick="openModal('modalPeriod')">ğŸ“… Zeitraum erstellen</button>`;
    return;
  }
  const now = new Date();
  const start = new Date(period.registration_start);
  const end = new Date(period.registration_end);
  let statusDot = '<span class="dot dot-muted"></span>';
  let statusText = 'Inaktiv';
  if (period.is_active) {
    if (now < start) { statusDot = '<span class="dot dot-yellow"></span>'; statusText = 'Startet bald'; }
    else if (now > end) { statusDot = '<span class="dot dot-red"></span>'; statusText = 'Abgelaufen'; }
    else { statusDot = '<span class="dot dot-green"></span>'; statusText = 'Offen'; }
  }
  el.innerHTML = `
    <div class="period-info">
      <div class="period-stat"><div class="period-stat-label">Name</div><div class="period-stat-value" style="font-size:14px;">${esc(period.name)}</div></div>
      <div class="period-stat"><div class="period-stat-label">Status</div><div class="period-stat-value" style="font-size:14px;">${statusDot}${statusText}</div></div>
      <div class="period-stat"><div class="period-stat-label">TeamgrÃ¶ÃŸe</div><div class="period-stat-value">${period.team_size || 6}</div></div>
      <div class="period-stat"><div class="period-stat-label">Start</div><div class="period-stat-value" style="font-size:13px;">${fmtDt(period.registration_start)}</div></div>
      <div class="period-stat"><div class="period-stat-label">Ende</div><div class="period-stat-value" style="font-size:13px;">${fmtDt(period.registration_end)}</div></div>
      <div class="period-stat"><div class="period-stat-label">Anmeldungen</div><div class="period-stat-value">${(summary || {}).signups_total || 0}</div></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary btn-sm" onclick="openModal('modalPeriod')">+ Neuer Zeitraum</button>
      <button class="btn btn-danger btn-sm" onclick="confirmClosePeriod(${period.id})">ğŸ”´ Zeitraum beenden</button>
    </div>`;
}

async function createPeriod() {
  const alertEl = document.getElementById('periodAlert');
  const name = document.getElementById('pName').value.trim();
  const start = document.getElementById('pStart').value;
  const end = document.getElementById('pEnd').value;
  const teamSize = parseInt(document.getElementById('pTeamSize').value) || 6;
  if (!name || !start || !end) { showAlert(alertEl, 'Alle Felder ausfÃ¼llen.'); return; }
  if (new Date(start) >= new Date(end)) { showAlert(alertEl, 'Anmeldebeginn muss vor Anmeldeschluss liegen.'); return; }
  try {
    await apiPost('/api/turnier/period', {
      guild_id: currentGuildId, name, team_size: teamSize,
      registration_start: start + ':00',
      registration_end: end + ':00',
    });
    closeModal('modalPeriod');
    await loadData();
  } catch(e) { showAlert(alertEl, e.message); }
}

function confirmClosePeriod(pid) {
  openConfirm('Zeitraum beenden', 'Soll der aktive Zeitraum wirklich beendet werden?', async () => {
    await apiPost('/api/turnier/period/close', { guild_id: currentGuildId, period_id: pid });
    await loadData();
  });
}

// â”€â”€ Signups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSignups() {
  const search = (document.getElementById('signupSearch')?.value || '').toLowerCase();
  let filtered = allSignups.filter(s =>
    !search || (s.display_name || '').toLowerCase().includes(search)
      || (s.team_name || '').toLowerCase().includes(search)
      || (s.rank_label || '').toLowerCase().includes(search)
  );
  const total = filtered.length;
  const maxPage = Math.max(0, Math.ceil(total / PAGE_SIZE) - 1);
  if (signupPage > maxPage) signupPage = maxPage;
  const page = filtered.slice(signupPage * PAGE_SIZE, (signupPage + 1) * PAGE_SIZE);
  const el = document.getElementById('signupsContent');
  if (!filtered.length) { el.innerHTML = `<div class="empty-hint">Keine Anmeldungen gefunden.</div>`; renderPagination(0,0); return; }

  el.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>#</th><th>Spieler</th><th>Rang</th><th>Sub</th><th>Modus</th><th>Team</th><th>Aktionen</th></tr></thead>
    <tbody>${page.map((s, i) => {
      const idx = signupPage * PAGE_SIZE + i + 1;
      const rankLabel = (s.rank_label || s.rank || 'â€”').charAt(0).toUpperCase() + (s.rank_label || s.rank || '').slice(1);
      const sub = s.rank_subvalue > 0 ? ` ${s.rank_subvalue}` : '';
      const mode = s.registration_mode === 'team' ? '<span class="badge badge-blue">Team</span>' : '<span class="badge badge-muted">Solo</span>';
      return `<tr>
        <td style="color:var(--muted)">${idx}</td>
        <td><strong>${esc(s.display_name || s.user_id)}</strong></td>
        <td>${esc(rankLabel)}${sub}</td>
        <td style="color:var(--muted)">${s.rank_subvalue || 'â€”'}</td>
        <td>${mode}</td>
        <td>${s.team_name ? esc(s.team_name) : '<span style="color:var(--muted)">â€”</span>'}</td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="removeSignup(${s.user_id}, '${esc(s.display_name || s.user_id)}')">Entfernen</button>
        </td>
      </tr>`;
    }).join('')}</tbody></table></div>`;
  renderPagination(signupPage, maxPage);
}

function renderPagination(page, maxPage) {
  const el = document.getElementById('signupPagination');
  if (maxPage <= 0) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  el.innerHTML = `
    <button class="btn btn-muted btn-sm" onclick="changePage(-1)" ${page===0?'disabled':''}>â—€</button>
    <span class="page-info">Seite ${page+1} / ${maxPage+1}</span>
    <button class="btn btn-muted btn-sm" onclick="changePage(1)" ${page>=maxPage?'disabled':''}>â–¶</button>`;
}

function changePage(dir) { signupPage += dir; renderSignups(); }

async function removeSignup(userId, name) {
  openConfirm('Anmeldung entfernen', `â€${name}" aus dem Turnier entfernen?`, async () => {
    await apiPost('/api/turnier/remove', { guild_id: currentGuildId, user_id: userId });
    await loadData();
  });
}

function confirmClearSignups() {
  openConfirm('Alle Anmeldungen lÃ¶schen', 'Wirklich ALLE Anmeldungen unwiderruflich lÃ¶schen? Teams bleiben erhalten.', async () => {
    await apiPost('/api/turnier/clear', { guild_id: currentGuildId });
    await loadData();
  });
}

// â”€â”€ Teams â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTeams(teams, signups, period) {
  const el = document.getElementById('teamsContent');
  if (!teams.length) { el.innerHTML = `<div class="empty-hint">Noch keine Teams erstellt.</div>`; return; }
  const teamMembers = {};
  signups.forEach(s => {
    if (s.team_id) {
      const tid = s.team_id;
      if (!teamMembers[tid]) teamMembers[tid] = [];
      teamMembers[tid].push(s);
    }
  });
  const maxSize = (period && period.team_size) ? period.team_size : 6;
  el.innerHTML = `<div class="teams-grid">${teams.map(t => {
    const members = teamMembers[t.id] || [];
    const count = members.length;
    const badge = count >= maxSize ? '<span class="badge badge-red">Voll</span>' : `<span class="badge badge-muted">${count}/${maxSize}</span>`;
    return `<div class="team-card">
      <div class="team-card-name">${esc(t.name)} ${badge}</div>
      ${members.length ? members.map(m => {
        const rank = (m.rank_label || m.rank || '?');
        const sub = m.rank_subvalue > 0 ? ` ${m.rank_subvalue}` : '';
        return `<div class="team-member">ğŸ‘¤ ${esc(m.display_name || m.user_id)} <span style="float:right;opacity:.6">${esc(rank)}${sub}</span></div>`;
      }).join('') : '<div class="team-member" style="font-style:italic;">Keine Mitglieder</div>'}
      <div class="team-actions">
        <button class="btn btn-danger btn-sm" onclick="deleteTeam(${t.id},'${esc(t.name)}')">LÃ¶schen</button>
      </div>
    </div>`;
  }).join('')}</div>`;
}

async function createTeam() {
  const alertEl = document.getElementById('teamAlert');
  const name = document.getElementById('tName').value.trim();
  if (!name) { showAlert(alertEl, 'Teamname eingeben.'); return; }
  try {
    await apiPost('/api/turnier/team', { guild_id: currentGuildId, name });
    closeModal('modalTeam');
    document.getElementById('tName').value = '';
    await loadData();
  } catch(e) { showAlert(alertEl, e.message); }
}

async function deleteTeam(tid, name) {
  openConfirm('Team lÃ¶schen', `Team â€${name}" lÃ¶schen? Mitglieder werden zu Solo-Anmeldungen.`, async () => {
    await apiPost('/api/turnier/team/delete', { guild_id: currentGuildId, team_id: tid });
    await loadData();
  });
}

// â”€â”€ Bracket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBracket() {
  document.getElementById('bracketContent').innerHTML = '<div class="loading-wrap"><div class="spinner"></div> Generiere Bracketâ€¦</div>';
  try {
    const params = currentGuildId ? `?guild_id=${currentGuildId}` : '';
    const data = await apiGet(`/api/turnier/bracket${params}`);
    renderBracket(data.bracket);
  } catch(e) {
    document.getElementById('bracketContent').innerHTML = `<div style="color:var(--danger)">Fehler: ${esc(e.message)}</div>`;
  }
}

function renderBracket(bracket) {
  const el = document.getElementById('bracketContent');
  if (bracket.error) { el.innerHTML = `<div style="color:var(--muted);font-style:italic;">${esc(bracket.error)}</div>`; return; }
  const rounds = bracket.rounds || [];
  if (!rounds.length) { el.innerHTML = `<div style="color:var(--muted);font-style:italic;">Keine Runden generiert.</div>`; return; }

  let html = `<div style="margin-bottom:12px;color:var(--muted);font-size:12px;">${bracket.num_entries} Teilnehmer Â· ${bracket.num_rounds} Runden Â· ${bracket.slots} Slots</div>`;
  html += '<div class="bracket">';
  rounds.forEach(round => {
    html += `<div class="bracket-round">
      <div class="bracket-round-label">${esc(round.label)}</div>`;
    round.matches.forEach(m => {
      const eA = m.entry_a;
      const eB = m.entry_b;
      const winId = m.winner ? m.winner.id : null;
      function entryHtml(e) {
        if (!e) return `<div class="bracket-entry bye">BYE</div>`;
        const isWinner = winId && e.id === winId;
        const isTbd = !e.name;
        const cls = isTbd ? 'tbd' : isWinner ? 'winner' : '';
        const score = e.score ? `<span class="bracket-score">Ã˜ ${e.score}</span>` : '';
        return `<div class="bracket-entry ${cls}">${esc(e.name || 'TBD')} ${score}</div>`;
      }
      html += `<div class="bracket-match">${entryHtml(eA)}<div class="bracket-divider"></div>${entryHtml(eB)}</div>`;
    });
    html += `</div>`;
  });
  html += '</div>';
  el.innerHTML = html;
}

// â”€â”€ Confirm modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let confirmCallback = null;
function openConfirm(title, text, cb) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmText').textContent = text;
  confirmCallback = cb;
  const btn = document.getElementById('confirmOkBtn');
  btn.onclick = async () => { closeModal('modalConfirm'); if (cb) await cb(); };
  openModal('modalConfirm');
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
  if (id === 'modalPeriod') {
    // Pre-fill start with "now rounded up to next hour", end with "+7 days 23:59"
    const now = new Date();
    now.setMinutes(0, 0, 0);
    now.setHours(now.getHours() + 1);
    const end = new Date(now);
    end.setDate(end.getDate() + 7);
    end.setHours(23, 59, 0, 0);
    function toLocal(d) {
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    const startEl = document.getElementById('pStart');
    const endEl = document.getElementById('pEnd');
    if (!startEl.value) startEl.value = toLocal(now);
    if (!endEl.value) endEl.value = toLocal(end);
  }
}
function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
  document.querySelectorAll(`#${id} .alert`).forEach(a => a.classList.add('hidden'));
  if (id === 'modalPeriod') {
    document.getElementById('pStart').value = '';
    document.getElementById('pEnd').value = '';
  }
}
function showAlert(el, msg) { el.textContent = msg; el.classList.remove('hidden'); }

// â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtDt(s) {
  if (!s) return 'â€”';
  try {
    const d = new Date(s);
    return d.toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) + ' Uhr';
  } catch { return s; }
}
function showError(msg) { console.error(msg); }

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) { const id = o.id; if (id !== 'modalConfirm') closeModal(id); } });
});

init();
</script>
</body>
</html>
