<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Turnier â€“ EarlySalty</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d2e;
  --surface2: #232640;
  --border: #2e3250;
  --accent: #6c63ff;
  --accent2: #ff6b6b;
  --green: #43e97b;
  --gold: #ffd700;
  --text: #e8eaf0;
  --muted: #8b90a7;
  --danger: #e74c3c;
  --success: #27ae60;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; }

/* Layout */
.topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
.topbar-title { font-size: 18px; font-weight: 700; color: var(--gold); display: flex; align-items: center; gap: 8px; }
.topbar-user { color: var(--muted); font-size: 13px; display: flex; align-items: center; gap: 12px; }
.topbar-user a { color: var(--accent); text-decoration: none; cursor: pointer; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; gap: 20px; }

/* Cards */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 18px; }
.card-title { font-size: 15px; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }

/* Buttons */
.btn { padding: 7px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: opacity .15s; display: inline-flex; align-items: center; gap: 6px; text-decoration: none; }
.btn:hover { opacity: .85; }
.btn:disabled { opacity: .4; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-muted { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-sm { padding: 4px 9px; font-size: 12px; }

/* Badges */
.badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
.badge-green { background: rgba(67,233,123,.15); color: var(--green); border: 1px solid rgba(67,233,123,.3); }
.badge-red { background: rgba(231,76,60,.15); color: var(--danger); border: 1px solid rgba(231,76,60,.3); }
.badge-gold { background: rgba(255,215,0,.12); color: var(--gold); border: 1px solid rgba(255,215,0,.3); }
.badge-blue { background: rgba(108,99,255,.15); color: #8b8fff; border: 1px solid rgba(108,99,255,.3); }
.badge-muted { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }

/* Alert */
.alert { padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-bottom: 12px; }
.alert-error { background: rgba(231,76,60,.12); border: 1px solid rgba(231,76,60,.3); color: #ff7675; }
.alert-success { background: rgba(39,174,96,.12); border: 1px solid rgba(39,174,96,.3); color: var(--green); }
.alert-info { background: rgba(108,99,255,.12); border: 1px solid rgba(108,99,255,.3); color: #8b8fff; }
.hidden { display: none !important; }

/* Period Banner */
.period-banner { border-radius: 8px; padding: 16px 20px; margin-bottom: 4px; }
.period-banner.open { background: rgba(67,233,123,.08); border: 1px solid rgba(67,233,123,.25); }
.period-banner.closed { background: rgba(231,76,60,.08); border: 1px solid rgba(231,76,60,.25); }
.period-banner.pending { background: rgba(255,215,0,.08); border: 1px solid rgba(255,215,0,.25); }
.period-banner.none { background: var(--surface2); border: 1px solid var(--border); }
.period-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.period-meta { color: var(--muted); font-size: 12px; margin-top: 4px; }

/* My Status */
.status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin-bottom: 12px; }
.status-stat { background: var(--surface2); border-radius: 8px; padding: 10px 14px; }
.status-stat-label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
.status-stat-value { font-size: 14px; font-weight: 700; margin-top: 4px; }

/* Teams Grid */
.teams-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; }
.team-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
.team-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 8px; }
.team-card-name { font-weight: 700; font-size: 14px; flex: 1; }
.team-card-count { color: var(--muted); font-size: 12px; white-space: nowrap; }
.team-member-list { list-style: none; }
.team-member { font-size: 12px; color: var(--muted); padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,.04); display: flex; align-items: center; justify-content: space-between; gap: 6px; }
.team-member:last-child { border-bottom: none; }
.team-member-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.team-actions { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
.rename-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 6px 10px; font-size: 12px; outline: none; margin-top: 6px; }
.rename-input:focus { border-color: var(--accent); }

/* Solo list */
.solo-list { list-style: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; }
.solo-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 13px; }
.solo-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Collapsible */
details summary { cursor: pointer; list-style: none; user-select: none; }
details summary::before { content: "â–¶ "; font-size: 11px; color: var(--muted); }
details[open] summary::before { content: "â–¼ "; }

/* Bracket */
.bracket { display: flex; gap: 0; overflow-x: auto; padding: 10px 0; }
.bracket-round { display: flex; flex-direction: column; justify-content: space-around; min-width: 180px; position: relative; }
.bracket-round-label { text-align: center; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); margin-bottom: 12px; font-weight: 700; }
.bracket-match { display: flex; flex-direction: column; gap: 2px; margin: 8px; flex: 1; justify-content: center; }
.bracket-entry { background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 7px 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; cursor: default; transition: border-color .15s; }
.bracket-entry:hover { border-color: var(--accent); }
.bracket-entry.tbd { opacity: .4; font-style: italic; }
.bracket-entry.bye { opacity: .35; font-style: italic; }
.bracket-score { font-size: 10px; color: var(--muted); }
.bracket-divider { height: 1px; background: var(--border); margin: 2px 8px; }

/* Loading */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-wrap { display: flex; align-items: center; gap: 10px; color: var(--muted); padding: 20px; }
.empty-hint { color: var(--muted); text-align: center; padding: 24px; font-style: italic; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">ğŸ† Turnier</div>
  <div class="topbar-user" id="topbarUser">
    <span id="userLabel"></span>
    <a id="authLink" href="/auth/login">Anmelden</a>
  </div>
</div>

<div class="container">
  <!-- Global alert -->
  <div id="globalAlert" class="alert hidden"></div>

  <!-- Period Banner -->
  <div id="periodBanner" class="period-banner none">
    <div class="loading-wrap"><span class="spinner"></span> Lade...</div>
  </div>

  <!-- My Status (only when logged in) -->
  <div id="myStatusCard" class="card hidden">
    <div class="card-title">ğŸ“Š Mein Status</div>
    <div id="myStatusContent"></div>
  </div>

  <!-- Teams -->
  <div class="card">
    <div class="card-title">ğŸ›¡ï¸ Teams</div>
    <div id="teamsContainer"><div class="loading-wrap"><span class="spinner"></span> Lade Teams...</div></div>
  </div>

  <!-- Solo Teilnehmer -->
  <div class="card">
    <details>
      <summary class="card-title" style="padding-bottom:0">ğŸ‘¤ Solo-Teilnehmer</summary>
      <div id="soloContainer" style="margin-top:12px"><div class="loading-wrap"><span class="spinner"></span></div></div>
    </details>
  </div>

  <!-- Bracket -->
  <div class="card">
    <div class="card-title">âš”ï¸ Bracket</div>
    <div id="bracketContainer"><div class="loading-wrap"><span class="spinner"></span> Lade Bracket...</div></div>
  </div>
</div>

<script>
'use strict';

let _state = {
  me: null,          // /api/me response
  overview: null,    // /api/overview response
};

// â”€â”€ utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function el(id) { return document.getElementById(id); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function showAlert(msg, type='error') {
  const d = el('globalAlert');
  d.className = `alert alert-${type}`;
  d.textContent = msg;
  d.classList.remove('hidden');
  setTimeout(() => d.classList.add('hidden'), 6000);
}

async function apiFetch(url, opts={}) {
  const csrf = _state.me?.user?.csrf_token;
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (csrf) headers['X-CSRF-Token'] = csrf;
  const r = await fetch(url, { ...opts, headers });
  const data = await r.json().catch(() => ({}));
  return { ok: r.ok, status: r.status, data };
}

// â”€â”€ Auth header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderTopbar() {
  const me = _state.me;
  if (me?.logged_in) {
    el('userLabel').textContent = me.user.display_name;
    const link = el('authLink');
    link.textContent = 'Abmelden';
    link.href = '/auth/logout';
  } else {
    el('userLabel').textContent = '';
    const link = el('authLink');
    link.textContent = 'Mit Discord anmelden';
    link.href = '/auth/login';
  }
}

// â”€â”€ Period Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderPeriodBanner() {
  const ov = _state.overview;
  const me = _state.me;
  const banner = el('periodBanner');
  const period = ov?.active_period;

  if (!period) {
    banner.className = 'period-banner none';
    banner.innerHTML = '<div class="period-title"><span class="badge badge-muted">Kein aktiver Anmeldezeitraum</span></div>';
    return;
  }

  const now = new Date();
  const start = new Date(period.registration_start);
  const end = new Date(period.registration_end);
  const isOpen = start <= now && now <= end;
  const isPending = now < start;

  let cls = isOpen ? 'open' : (isPending ? 'pending' : 'closed');
  let badgeClass = isOpen ? 'badge-green' : (isPending ? 'badge-gold' : 'badge-red');
  let statusLabel = isOpen ? 'ğŸŸ¢ Offen' : (isPending ? 'â³ Startet bald' : 'ğŸ”´ Abgelaufen');

  let html = `<div class="period-title"><span>${esc(period.name)}</span><span class="badge ${badgeClass}">${statusLabel}</span></div>`;
  html += `<div class="period-meta">ğŸ“… ${fmtDate(period.registration_start)} â€“ ${fmtDate(period.registration_end)} &nbsp;|&nbsp; TeamgrÃ¶ÃŸe: <b>${period.team_size || 6}</b></div>`;

  // Signup button
  if (me?.logged_in && isOpen) {
    const signup = me.signup;
    if (signup) {
      html += `<div style="margin-top:10px"><span class="badge badge-green">âœ… Angemeldet</span></div>`;
    } else {
      html += `<div style="margin-top:10px"><button class="btn btn-success btn-sm" onclick="openSignupFlow()">Jetzt anmelden</button></div>`;
    }
  } else if (!me?.logged_in && isOpen) {
    html += `<div style="margin-top:10px"><a class="btn btn-primary btn-sm" href="/auth/login">Anmelden um mitzumachen</a></div>`;
  }

  banner.className = `period-banner ${cls}`;
  banner.innerHTML = html;
}

function fmtDate(s) {
  if (!s) return 'â€”';
  try {
    const d = new Date(s);
    return d.toLocaleString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
  } catch { return s; }
}

// â”€â”€ My Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderMyStatus() {
  const me = _state.me;
  const card = el('myStatusCard');
  if (!me?.logged_in) { card.classList.add('hidden'); return; }
  card.classList.remove('hidden');

  const signup = me.signup;
  const content = el('myStatusContent');
  if (!signup) {
    content.innerHTML = '<p style="color:var(--muted)">Du bist noch nicht angemeldet.</p>';
    return;
  }

  const rankLabel = signup.rank_subvalue > 0
    ? `${capitalize(signup.rank || 'Unbekannt')} ${signup.rank_subvalue}`
    : capitalize(signup.rank || 'Unbekannt');

  const mode = signup.registration_mode === 'team' ? 'Team' : 'Solo';
  const team = signup.team_name || 'â€”';

  let html = `<div class="status-grid">
    <div class="status-stat"><div class="status-stat-label">Rang</div><div class="status-stat-value">${esc(rankLabel)}</div></div>
    <div class="status-stat"><div class="status-stat-label">Modus</div><div class="status-stat-value">${esc(mode)}</div></div>
    <div class="status-stat"><div class="status-stat-label">Team</div><div class="status-stat-value">${esc(team)}</div></div>
  </div>`;

  html += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px">
    <button class="btn btn-danger btn-sm" onclick="doWithdraw()">Abmelden</button>`;
  if (!signup.team_id) {
    html += `<button class="btn btn-muted btn-sm" onclick="openTeamCreateFlow()">Team erstellen</button>`;
  }
  html += `</div>`;

  content.innerHTML = html;
}

// â”€â”€ Teams Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderTeams() {
  const ov = _state.overview;
  const me = _state.me;
  const container = el('teamsContainer');
  if (!ov) { container.innerHTML = '<div class="empty-hint">Lade...</div>'; return; }

  const teams = ov.teams || [];
  if (!teams.length) {
    container.innerHTML = '<div class="empty-hint">Noch keine Teams. Melde dich an und erstelle ein Team!</div>';
    return;
  }

  const myUserId = me?.logged_in ? me.user.id : null;
  const period = ov.active_period;
  const teamSize = period?.team_size || 6;

  let html = '<div class="teams-grid">';
  for (const t of teams) {
    const isCreator = myUserId && t.created_by == myUserId;
    const members = t.members || [];
    const count = members.length;
    const full = count >= teamSize;

    html += `<div class="team-card" data-team-id="${t.id}">
      <div class="team-card-header">
        <div class="team-card-name">${esc(t.name)}</div>
        <div class="team-card-count">${count}/${teamSize}</div>
      </div>`;

    if (members.length) {
      html += '<ul class="team-member-list">';
      for (const m of members) {
        const rankStr = m.rank_subvalue > 0
          ? `${capitalize(m.rank || '')} ${m.rank_subvalue}`
          : capitalize(m.rank || '');
        html += `<li class="team-member">
          <span class="team-member-name">${esc(m.display_name)}</span>
          <span class="badge badge-muted" style="font-size:10px">${esc(rankStr)}</span>`;
        if (isCreator && m.user_id != myUserId) {
          html += `<button class="btn btn-danger btn-sm" onclick="doKick(${t.id}, ${m.user_id})" title="Entfernen">âœ•</button>`;
        }
        html += '</li>';
      }
      html += '</ul>';
    } else {
      html += '<div class="empty-hint" style="padding:10px 0 0">Keine Mitglieder.</div>';
    }

    if (isCreator) {
      html += `<div class="team-actions">
        <button class="btn btn-muted btn-sm" onclick="toggleRename(${t.id})">Umbenennen</button>
      </div>
      <div id="renameBox-${t.id}" class="hidden">
        <input class="rename-input" id="renameInput-${t.id}" placeholder="${esc(t.name)}" maxlength="32">
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="btn btn-primary btn-sm" onclick="doRename(${t.id})">Speichern</button>
          <button class="btn btn-muted btn-sm" onclick="toggleRename(${t.id})">Abbrechen</button>
        </div>
      </div>`;
    }

    html += '</div>';
  }
  html += '</div>';
  container.innerHTML = html;
}

function toggleRename(teamId) {
  const box = el(`renameBox-${teamId}`);
  box.classList.toggle('hidden');
  if (!box.classList.contains('hidden')) {
    el(`renameInput-${teamId}`)?.focus();
  }
}

// â”€â”€ Solo list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderSolo() {
  const ov = _state.overview;
  const container = el('soloContainer');
  if (!ov) { container.innerHTML = ''; return; }

  const solos = ov.solo_signups || [];
  if (!solos.length) {
    container.innerHTML = '<div class="empty-hint">Keine Solo-Teilnehmer.</div>';
    return;
  }

  let html = '<ul class="solo-list">';
  for (const s of solos) {
    const rankStr = s.rank_subvalue > 0
      ? `${capitalize(s.rank || '')} ${s.rank_subvalue}`
      : capitalize(s.rank || '');
    html += `<li class="solo-item">
      <span class="solo-item-name">${esc(s.display_name)}</span>
      <span class="badge badge-muted" style="font-size:10px">${esc(rankStr)}</span>
    </li>`;
  }
  html += '</ul>';
  container.innerHTML = html;
}

// â”€â”€ Bracket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderBracket() {
  const ov = _state.overview;
  const container = el('bracketContainer');
  if (!ov) { container.innerHTML = '<div class="empty-hint">Lade...</div>'; return; }

  const bracket = ov.bracket;
  if (!bracket || bracket.error || !bracket.rounds?.length) {
    container.innerHTML = `<div class="empty-hint">${esc(bracket?.error || 'Noch keine Bracket-Daten verfÃ¼gbar.')}</div>`;
    return;
  }

  let html = '<div class="bracket">';
  for (const round of bracket.rounds) {
    html += `<div class="bracket-round">
      <div class="bracket-round-label">${esc(round.label)}</div>`;
    for (const match of round.matches) {
      html += '<div class="bracket-match">';
      html += renderBracketEntry(match.entry_a, match.is_bye && !match.entry_b);
      html += '<div class="bracket-divider"></div>';
      html += renderBracketEntry(match.entry_b, match.is_bye && !match.entry_a);
      html += '</div>';
    }
    html += '</div>';
  }
  html += '</div>';
  container.innerHTML = html;
}

function renderBracketEntry(entry, isBye) {
  if (!entry) {
    return `<div class="bracket-entry tbd">TBD</div>`;
  }
  const cls = isBye ? 'bye' : '';
  return `<div class="bracket-entry ${cls}">
    <span>${esc(entry.name)}</span>
    <span class="bracket-score">${entry.score ?? ''}</span>
  </div>`;
}

// â”€â”€ Signup flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function openSignupFlow() {
  const mode = confirm('Solo anmelden?\n\nOK = Solo\nAbbrechen = Team-Anmeldung') ? 'solo' : 'team';
  if (mode === 'team') {
    openTeamSignupFlow();
    return;
  }
  const { ok, data } = await apiFetch('/api/signup', {
    method: 'POST',
    body: JSON.stringify({ mode: 'solo' }),
  });
  if (ok) {
    showAlert('Erfolgreich angemeldet!', 'success');
    await refresh();
  } else {
    showAlert(data.error || 'Fehler bei der Anmeldung.');
  }
}

async function openTeamSignupFlow() {
  const teams = _state.overview?.teams || [];
  const period = _state.overview?.active_period;
  const teamSize = period?.team_size || 6;

  // Build options
  const nonFull = teams.filter(t => (t.members?.length || 0) < teamSize);
  let msg = 'Team auswÃ¤hlen oder neu erstellen.\n\n';
  if (nonFull.length) {
    msg += 'Existierende Teams (Nummer eingeben):\n';
    nonFull.forEach((t, i) => {
      msg += `${i+1}. ${t.name} (${t.members?.length || 0}/${teamSize})\n`;
    });
    msg += `\nOder "N" fÃ¼r neues Team eingeben:`;
  } else {
    msg += 'Kein Team verfÃ¼gbar. Gib einen Teamnamen ein:';
  }

  const input = prompt(msg);
  if (!input) return;

  let payload;
  if (nonFull.length && /^\d+$/.test(input.trim())) {
    const idx = parseInt(input.trim()) - 1;
    if (idx < 0 || idx >= nonFull.length) { showAlert('UngÃ¼ltige Auswahl.'); return; }
    payload = { mode: 'team', team_id: nonFull[idx].id };
  } else if (input.trim().toUpperCase() === 'N' || !nonFull.length) {
    const name = prompt('Teamname eingeben:');
    if (!name?.trim()) return;
    payload = { mode: 'team', team_name: name.trim() };
  } else {
    payload = { mode: 'team', team_name: input.trim() };
  }

  const { ok, data } = await apiFetch('/api/signup', {
    method: 'POST',
    body: JSON.stringify(payload),
  });
  if (ok) {
    showAlert('Team-Anmeldung erfolgreich!', 'success');
    await refresh();
  } else {
    showAlert(data.error || 'Fehler bei der Team-Anmeldung.');
  }
}

async function doWithdraw() {
  if (!confirm('Wirklich abmelden?')) return;
  const { ok, data } = await apiFetch('/api/withdraw', { method: 'POST', body: '{}' });
  if (ok) {
    showAlert('Erfolgreich abgemeldet.', 'success');
    await refresh();
  } else {
    showAlert(data.error || 'Fehler.');
  }
}

async function openTeamCreateFlow() {
  const name = prompt('Teamname:');
  if (!name?.trim()) return;
  const { ok, data } = await apiFetch('/api/team/create', {
    method: 'POST',
    body: JSON.stringify({ name: name.trim() }),
  });
  if (ok) {
    showAlert('Team erstellt!', 'success');
    await refresh();
  } else {
    showAlert(data.error || 'Fehler.');
  }
}

async function doRename(teamId) {
  const input = el(`renameInput-${teamId}`);
  const name = input?.value?.trim();
  if (!name) return;
  const { ok, data } = await apiFetch('/api/team/rename', {
    method: 'POST',
    body: JSON.stringify({ team_id: teamId, name }),
  });
  if (ok) {
    showAlert('Team umbenannt.', 'success');
    await refresh();
  } else {
    showAlert(data.error || 'Fehler.');
  }
}

async function doKick(teamId, userId) {
  if (!confirm('Mitglied entfernen?')) return;
  const { ok, data } = await apiFetch('/api/team/kick', {
    method: 'POST',
    body: JSON.stringify({ team_id: teamId, user_id: userId }),
  });
  if (ok) {
    showAlert('Mitglied entfernt.', 'success');
    await refresh();
  } else {
    showAlert(data.error || 'Fehler.');
  }
}

// â”€â”€ data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadMe() {
  try {
    const r = await fetch('/api/me');
    _state.me = await r.json();
  } catch {
    _state.me = { logged_in: false };
  }
}

async function loadOverview() {
  try {
    const r = await fetch('/api/overview');
    _state.overview = await r.json();
  } catch {
    _state.overview = null;
  }
}

async function refresh() {
  await Promise.all([loadMe(), loadOverview()]);
  renderAll();
}

function renderAll() {
  renderTopbar();
  renderPeriodBanner();
  renderMyStatus();
  renderTeams();
  renderSolo();
  renderBracket();
}

function capitalize(s) {
  if (!s) return '';
  return s.charAt(0).toUpperCase() + s.slice(1);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(async () => {
  await refresh();
  // Auto-refresh every 30 seconds
  setInterval(refresh, 30000);
})();
</script>
</body>
</html>
