name: "ðŸ¤– Autofix Maintenance PR"

on:
  schedule:
    - cron: "35 2 * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: autofix-maintenance-${{ github.repository }}
  cancel-in-progress: true

jobs:
  autofix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20"

      - name: Apply safe autofixes
        run: |
          set -euo pipefail

          echo "Installing tools..."
          python -m pip install -r .github/workflows/requirements-tools.txt

          echo "Running ruff --fix..."
          ruff check . --fix || true
          ruff format . || true

          if [ -f "cogs/steam/steam_presence/package-lock.json" ]; then
            echo "Running npm audit fix (lockfile only)..."
            npm --prefix cogs/steam/steam_presence audit fix --package-lock-only --omit=dev || true
          fi

      - name: Create or update autofix PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No autofix changes detected."
            exit 0
          fi

          BASE_BRANCH="${{ github.event.repository.default_branch }}"
          if [ -z "${BASE_BRANCH}" ]; then
            BASE_BRANCH="main"
          fi

          BRANCH="bot/autofix-maintenance"
          TITLE="chore(autofix): automated maintenance fixes"
          BODY_FILE="$(mktemp)"

          cat > "${BODY_FILE}" << 'EOF'
          ## Automated Autofix PR

          This PR was created by the `Autofix Maintenance PR` workflow and includes safe automated fixes:
          - Python lint/style autofixes via Ruff (`check --fix`, `format`)
          - NPM lockfile vulnerability remediation via `npm audit fix --package-lock-only`

          If required checks and branch protections pass, the companion auto-merge workflow can merge this automatically.
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -B "${BRANCH}"
          git add -A
          git commit -m "chore(autofix): apply automated maintenance fixes"
          git push --force origin "${BRANCH}"

          existing_pr="$(gh pr list --state open --base "${BASE_BRANCH}" --head "${BRANCH}" --json number --jq '.[0].number')"

          if [ -n "${existing_pr}" ]; then
            echo "Updating existing PR #${existing_pr}"
            gh pr edit "${existing_pr}" --title "${TITLE}" --body-file "${BODY_FILE}"
          else
            echo "Creating new PR against ${BASE_BRANCH}"
            gh pr create \
              --base "${BASE_BRANCH}" \
              --head "${BRANCH}" \
              --title "${TITLE}" \
              --body-file "${BODY_FILE}"
          fi
