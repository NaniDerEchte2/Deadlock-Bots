name: "âš¡ Performance Analysis (Optimized)"

on:
  pull_request:
  schedule:
    - cron: '0 5 * * 0'  # Weekly on Sunday
  workflow_dispatch:

permissions: read-all

jobs:
  # ============================================================================
  # DETECT PROJECT TYPE
  # ============================================================================
  detect-project:
    name: ðŸ” Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      has_python: ${{ steps.check.outputs.has_python }}
      has_javascript: ${{ steps.check.outputs.has_javascript }}
      has_requirements: ${{ steps.check.outputs.has_requirements }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: Check Project Type
        id: check
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi
          
          if find . -name "*.js" -o -name "*.ts" | grep -q .; then
            echo "has_javascript=true" >> $GITHUB_OUTPUT
          else
            echo "has_javascript=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -f requirements.txt ]; then
            echo "has_requirements=true" >> $GITHUB_OUTPUT
          else
            echo "has_requirements=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # PYTHON PERFORMANCE - ONLY IF PYTHON EXISTS
  # ============================================================================
  python-performance:
    name: ðŸ Python Performance
    needs: detect-project
    if: needs.detect-project.outputs.has_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Set up uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0

      # Complexity Analysis
      - name: Complexity Analysis
        run: |
          echo "# Performance Analysis" > performance-report.md
          echo "" >> performance-report.md
          echo "## Cyclomatic Complexity:" >> performance-report.md
          uvx --with radon==6.0.1 radon cc . -a --total-average >> performance-report.md || echo "No data" >> performance-report.md
          echo "" >> performance-report.md
          echo "## Maintainability Index:" >> performance-report.md
          uvx --with radon==6.0.1 radon mi . -s >> performance-report.md || echo "No data" >> performance-report.md
          cat performance-report.md
        continue-on-error: true

      # Dead Code Detection
      - name: Find Dead Code
        run: |
          echo "" >> performance-report.md
          echo "## Potential Dead Code:" >> performance-report.md
          uvx --with vulture==2.14 vulture . --min-confidence 80 >> performance-report.md || echo "Analysis failed" >> performance-report.md
        continue-on-error: true

      # Find Nested Loops (Performance Bottlenecks)
      - name: Find Nested Loops
        run: |
          echo "" >> performance-report.md
          echo "## Nested Loops (Potential O(nÂ²)):" >> performance-report.md
          grep -rn "for.*for" --include="*.py" . | head -10 >> performance-report.md || echo "None found" >> performance-report.md
        continue-on-error: true

      - name: Upload Reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: python-performance
          path: performance-report.md
          if-no-files-found: ignore

  # ============================================================================
  # JAVASCRIPT PERFORMANCE - ONLY IF JS EXISTS
  # ============================================================================
  javascript-performance:
    name: ðŸ“¦ JavaScript Performance
    needs: detect-project
    if: needs.detect-project.outputs.has_javascript == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'

      # Check for large dependencies
      - name: Dependency Size Check
        if: hashFiles('**/package.json') != ''
        run: |
          echo "# JavaScript Performance" > js-performance.md
          echo "" >> js-performance.md
          
          if [ -d node_modules ]; then
            echo "## Dependency Sizes:" >> js-performance.md
            du -sh node_modules/* 2>/dev/null | sort -hr | head -10 >> js-performance.md || echo "No node_modules" >> js-performance.md
          else
            echo "No node_modules directory found" >> js-performance.md
          fi
          
          cat js-performance.md
        continue-on-error: true

      # Memory Leak Patterns
      - name: Check Memory Patterns
        run: |
          echo "" >> js-performance.md
          echo "## Event Listeners (Memory Leak Risk):" >> js-performance.md
          grep -rn "addEventListener\|on(" --include="*.js" --include="*.ts" . | wc -l >> js-performance.md || echo "0" >> js-performance.md
        continue-on-error: true

      - name: Upload Reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: javascript-performance
          path: js-performance.md
          if-no-files-found: ignore

  # ============================================================================
  # GENERAL PERFORMANCE ANALYSIS
  # ============================================================================
  general-analysis:
    name: ðŸ’¾ General Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Project Size Analysis
        run: |
          echo "# Project Resource Analysis" > resource-analysis.md
          echo "" >> resource-analysis.md
          echo "## Project Statistics:" >> resource-analysis.md
          echo "Total Files: $(find . -type f | wc -l)" >> resource-analysis.md
          echo "Total Size: $(du -sh . | cut -f1)" >> resource-analysis.md
          echo "" >> resource-analysis.md
          echo "## Largest Files:" >> resource-analysis.md
          find . -type f -exec du -h {} + | sort -rh | head -10 >> resource-analysis.md || true
          cat resource-analysis.md
        continue-on-error: true

      - name: Upload Analysis
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: resource-analysis
          path: resource-analysis.md
          if-no-files-found: ignore

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: ðŸ“Š Performance Summary
    needs: [detect-project, python-performance, javascript-performance, general-analysis]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "# âš¡ Performance Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Project Detection:" >> $GITHUB_STEP_SUMMARY
          echo "- Python: ${{ needs.detect-project.outputs.has_python == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript: ${{ needs.detect-project.outputs.has_javascript == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Analyses:" >> $GITHUB_STEP_SUMMARY
          echo "- Python Performance: ${{ needs.python-performance.result == 'success' && 'âœ…' || needs.python-performance.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript Performance: ${{ needs.javascript-performance.result == 'success' && 'âœ…' || needs.javascript-performance.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- General Analysis: ${{ needs.general-analysis.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
