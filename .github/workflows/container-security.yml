name: "ðŸ³ Container & Docker Security"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  # ============================================================================
  # DOCKER IMAGE SCANNING
  # ============================================================================
  docker-security-scan:
    name: ðŸ‹ Docker Image Security
    runs-on: ubuntu-latest
    if: hashFiles('**/Dockerfile', '**/docker-compose.yml', '**/docker-compose.yaml') != ''
    steps:
      - uses: actions/checkout@v4

      # Find all Dockerfiles
      - name: Find Dockerfiles
        id: find-dockerfiles
        run: |
          dockerfiles=$(find . -name "Dockerfile*" -o -name "*.dockerfile" | tr '\n' ' ')
          echo "dockerfiles=$dockerfiles" >> $GITHUB_OUTPUT
          echo "Found Dockerfiles: $dockerfiles"

      # Hadolint - Dockerfile Linter
      - name: Hadolint Dockerfile Scan
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint.sarif
          no-fail: true
        continue-on-error: true

      - name: Upload Hadolint SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: hadolint.sarif
          category: 'hadolint'

      # Checkov - IaC Security
      - name: Checkov Docker Security
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: dockerfile
          output_format: sarif
          output_file_path: checkov-docker.sarif
          quiet: true
        continue-on-error: true

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-docker.sarif
          category: 'checkov-docker'

      # Trivy - Build and scan images if Dockerfile exists
      - name: Build Docker Image for Scanning
        if: hashFiles('**/Dockerfile') != ''
        run: |
          docker build -t test-image:latest .
        continue-on-error: true

      - name: Trivy Image Scan
        if: hashFiles('**/Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'test-image:latest'
          format: 'sarif'
          output: 'trivy-docker.sarif'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
        continue-on-error: true

      - name: Upload Trivy Docker SARIF
        if: hashFiles('**/Dockerfile') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-docker.sarif'
          category: 'trivy-docker-image'

  # ============================================================================
  # DOCKER COMPOSE SECURITY
  # ============================================================================
  docker-compose-security:
    name: ðŸ”§ Docker Compose Security
    runs-on: ubuntu-latest
    if: hashFiles('**/docker-compose.yml', '**/docker-compose.yaml') != ''
    steps:
      - uses: actions/checkout@v4

      # Validate compose files
      - name: Validate Docker Compose
        run: |
          if [ -f docker-compose.yml ]; then
            docker compose -f docker-compose.yml config > /dev/null
          fi
          if [ -f docker-compose.yaml ]; then
            docker compose -f docker-compose.yaml config > /dev/null
          fi

      # Checkov for docker-compose
      - name: Checkov Docker Compose Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: docker_compose
          output_format: sarif
          output_file_path: checkov-compose.sarif
        continue-on-error: true

      - name: Upload Compose Scan
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-compose.sarif
          category: 'checkov-docker-compose'

  # ============================================================================
  # CONTAINER BEST PRACTICES
  # ============================================================================
  container-best-practices:
    name: âš¡ Container Best Practices Check
    runs-on: ubuntu-latest
    if: hashFiles('**/Dockerfile') != ''
    steps:
      - uses: actions/checkout@v4

      - name: Check for Security Best Practices
        run: |
          echo "# Container Security Analysis" > container-analysis.md
          echo "" >> container-analysis.md
          
          # Check for root user
          if grep -r "USER root" . --include="Dockerfile*" > /dev/null; then
            echo "âš ï¸ WARNING: Root user found in Dockerfile" >> container-analysis.md
          else
            echo "âœ… Good: No explicit root user usage" >> container-analysis.md
          fi
          
          # Check for latest tag
          if grep -r ":latest" . --include="Dockerfile*" > /dev/null; then
            echo "âš ï¸ WARNING: Using :latest tag found" >> container-analysis.md
          else
            echo "âœ… Good: No :latest tags found" >> container-analysis.md
          fi
          
          # Check for secrets in Dockerfile
          if grep -rE "(PASSWORD|SECRET|TOKEN|KEY)=" . --include="Dockerfile*" > /dev/null; then
            echo "ðŸš¨ CRITICAL: Potential secrets in Dockerfile!" >> container-analysis.md
          else
            echo "âœ… Good: No obvious secrets in Dockerfile" >> container-analysis.md
          fi
          
          # Check for healthcheck
          if grep -r "HEALTHCHECK" . --include="Dockerfile*" > /dev/null; then
            echo "âœ… Good: HEALTHCHECK found" >> container-analysis.md
          else
            echo "âš ï¸ WARNING: No HEALTHCHECK defined" >> container-analysis.md
          fi
          
          # Check for multi-stage builds
          if grep -r "FROM.*AS" . --include="Dockerfile*" > /dev/null; then
            echo "âœ… Good: Multi-stage build detected" >> container-analysis.md
          else
            echo "â„¹ï¸ INFO: Single-stage build" >> container-analysis.md
          fi
          
          cat container-analysis.md

      - name: Upload Analysis
        uses: actions/upload-artifact@v4
        with:
          name: container-best-practices
          path: container-analysis.md

  # ============================================================================
  # IMAGE SIZE OPTIMIZATION CHECK
  # ============================================================================
  image-size-check:
    name: ðŸ“¦ Image Size Optimization
    runs-on: ubuntu-latest
    if: hashFiles('**/Dockerfile') != ''
    steps:
      - uses: actions/checkout@v4

      - name: Build and Analyze Image Size
        run: |
          if [ -f Dockerfile ]; then
            docker build -t size-check:latest .
            
            echo "# Image Size Analysis" > size-analysis.md
            echo "" >> size-analysis.md
            
            # Get image size
            size=$(docker images size-check:latest --format "{{.Size}}")
            echo "ðŸ“Š Image Size: $size" >> size-analysis.md
            
            # Get layer information
            echo "" >> size-analysis.md
            echo "## Layer Breakdown:" >> size-analysis.md
            docker history size-check:latest --human=true --no-trunc >> size-analysis.md
            
            # Use dive for deep analysis if available
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
              wagoodman/dive:latest size-check:latest --ci \
              --lowestEfficiency=0.9 --highestWastedBytes=20MB || true
            
            cat size-analysis.md
          fi
        continue-on-error: true

      - name: Upload Size Analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: image-size-analysis
          path: size-analysis.md
