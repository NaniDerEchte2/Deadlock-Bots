name: "ðŸ³ Container Security (Optimized)"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================================
  # CHECK IF DOCKER/CONTAINER FILES EXIST
  # ============================================================================
  detect-container-files:
    name: ðŸ” Detect Container Files
    runs-on: ubuntu-latest
    outputs:
      has_dockerfile: ${{ steps.check.outputs.has_dockerfile }}
      has_compose: ${{ steps.check.outputs.has_compose }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for Container Files
        id: check
        run: |
          # Check for Dockerfile
          if find . -name "Dockerfile*" -o -name "*.dockerfile" | grep -q .; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
            echo "âœ… Dockerfile found"
          else
            echo "has_dockerfile=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Dockerfile found - container scans will be skipped"
          fi
          
          # Check for docker-compose
          if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
            echo "has_compose=true" >> $GITHUB_OUTPUT
            echo "âœ… docker-compose file found"
          else
            echo "has_compose=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No docker-compose file found"
          fi

  # ============================================================================
  # DOCKERFILE LINTING - ONLY IF DOCKERFILE EXISTS
  # ============================================================================
  dockerfile-lint:
    name: ðŸ‹ Dockerfile Linting
    needs: detect-container-files
    if: needs.detect-container-files.outputs.has_dockerfile == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Hadolint - Dockerfile Linter
      - name: Hadolint Dockerfile Scan
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint.sarif
          no-fail: true
        continue-on-error: true

      - name: Upload Hadolint SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('hadolint.sarif') != ''
        with:
          sarif_file: hadolint.sarif
          category: 'hadolint'
        continue-on-error: true

      - name: Upload Hadolint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hadolint-report
          path: hadolint.sarif
          if-no-files-found: ignore

  # ============================================================================
  # DOCKER COMPOSE VALIDATION - ONLY IF COMPOSE EXISTS
  # ============================================================================
  compose-validate:
    name: ðŸ”§ Docker Compose Validation
    needs: detect-container-files
    if: needs.detect-container-files.outputs.has_compose == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          if [ -f docker-compose.yml ]; then
            echo "Validating docker-compose.yml..."
            docker compose -f docker-compose.yml config > /dev/null && echo "âœ… Valid" || echo "âš ï¸ Invalid"
          fi
          if [ -f docker-compose.yaml ]; then
            echo "Validating docker-compose.yaml..."
            docker compose -f docker-compose.yaml config > /dev/null && echo "âœ… Valid" || echo "âš ï¸ Invalid"
          fi
        continue-on-error: true

  # ============================================================================
  # BEST PRACTICES CHECK - ONLY IF DOCKERFILE EXISTS
  # ============================================================================
  best-practices:
    name: âš¡ Container Best Practices
    needs: detect-container-files
    if: needs.detect-container-files.outputs.has_dockerfile == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Security Best Practices
        run: |
          echo "# Container Security Analysis" > container-analysis.md
          echo "" >> container-analysis.md
          
          # Check for root user
          if grep -r "USER root" . --include="Dockerfile*" > /dev/null 2>&1; then
            echo "âš ï¸ WARNING: Root user found in Dockerfile" >> container-analysis.md
          else
            echo "âœ… Good: No explicit root user usage" >> container-analysis.md
          fi
          
          # Check for latest tag
          if grep -r ":latest" . --include="Dockerfile*" > /dev/null 2>&1; then
            echo "âš ï¸ WARNING: Using :latest tag found" >> container-analysis.md
          else
            echo "âœ… Good: No :latest tags found" >> container-analysis.md
          fi
          
          # Check for secrets
          if grep -rE "(PASSWORD|SECRET|TOKEN|KEY)=" . --include="Dockerfile*" > /dev/null 2>&1; then
            echo "ðŸš¨ CRITICAL: Potential secrets in Dockerfile!" >> container-analysis.md
          else
            echo "âœ… Good: No obvious secrets in Dockerfile" >> container-analysis.md
          fi
          
          # Check for healthcheck
          if grep -r "HEALTHCHECK" . --include="Dockerfile*" > /dev/null 2>&1; then
            echo "âœ… Good: HEALTHCHECK found" >> container-analysis.md
          else
            echo "â„¹ï¸ INFO: No HEALTHCHECK defined" >> container-analysis.md
          fi
          
          cat container-analysis.md

      - name: Upload Analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-best-practices
          path: container-analysis.md
          if-no-files-found: ignore

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: ðŸ“Š Container Security Summary
    needs: [detect-container-files, dockerfile-lint, compose-validate, best-practices]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "# ðŸ³ Container Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Files Detected:" >> $GITHUB_STEP_SUMMARY
          echo "- Dockerfile: ${{ needs.detect-container-files.outputs.has_dockerfile == 'true' && 'âœ… Found' || 'âŒ Not found' }}" >> $GITHUB_STEP_SUMMARY
          echo "- docker-compose: ${{ needs.detect-container-files.outputs.has_compose == 'true' && 'âœ… Found' || 'âŒ Not found' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-container-files.outputs.has_dockerfile }}" == "false" ]; then
            echo "â„¹ï¸ **No container files found - all checks were skipped**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable container scanning, add a Dockerfile to your repository." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Scans Executed:" >> $GITHUB_STEP_SUMMARY
            echo "- Dockerfile Linting: ${{ needs.dockerfile-lint.result == 'success' && 'âœ…' || needs.dockerfile-lint.result == 'skipped' && 'â­ï¸' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
            echo "- Compose Validation: ${{ needs.compose-validate.result == 'success' && 'âœ…' || needs.compose-validate.result == 'skipped' && 'â­ï¸' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
            echo "- Best Practices: ${{ needs.best-practices.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
