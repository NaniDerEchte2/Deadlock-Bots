name: "ðŸŒ Dashboard DAST"

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dashboard-dast:
    name: "ðŸ•·ï¸ Dashboard DAST (${{ matrix.name }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: stats
            target_path: /twitch/stats
          - name: dashboards
            target_path: /twitch/dashboards
          - name: api-v2-overview
            target_path: /twitch/api/v2/overview

    steps:
      - name: Checkout Repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Install Dashboard Runtime Dependencies
        run: |
          pip install --upgrade pip
          pip install aiohttp

      - name: Start Dashboard Test Server
        env:
          DEADLOCK_DB_PATH: ${{ github.workspace }}/.dast/deadlock.sqlite3
        run: |
          mkdir -p .github/tmp .dast
          cat > .github/tmp/run_dashboard_dast_server.py <<'PY'
          from aiohttp import web
          from cogs.twitch.dashboard_v2_server import build_v2_app

          app = build_v2_app(
              noauth=True,
              token="dast-token",
              partner_token="dast-partner",
          )
          web.run_app(app, host="127.0.0.1", port=8787, access_log=None)
          PY

          python .github/tmp/run_dashboard_dast_server.py > dashboard-dast-server.log 2>&1 &
          echo $! > dashboard-dast-server.pid

      - name: Wait for Dashboard Readiness
        run: |
          for i in $(seq 1 40); do
            if curl -fsS "http://127.0.0.1:8787/twitch/stats" > /dev/null; then
              echo "Dashboard test server is ready"
              exit 0
            fi
            sleep 1
          done
          echo "Dashboard test server did not become ready in time"
          cat dashboard-dast-server.log || true
          exit 1

      - name: OWASP ZAP Baseline Scan
        run: |
          docker run --rm --network host \
            -v "$PWD:/zap/wrk/:rw" \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t "http://127.0.0.1:8787${{ matrix.target_path }}" \
            -J "zap-${{ matrix.name }}.json" \
            -r "zap-${{ matrix.name }}.html" \
            -w "zap-${{ matrix.name }}.md" \
            -m 5 \
            -T 20 \
            -I || true

      - name: Upload DAST Reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: dashboard-dast-${{ matrix.name }}
          path: |
            zap-${{ matrix.name }}.json
            zap-${{ matrix.name }}.html
            zap-${{ matrix.name }}.md
          if-no-files-found: ignore

      - name: Upload Dashboard Server Log
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: dashboard-dast-server-log-${{ matrix.name }}
          path: dashboard-dast-server.log
          if-no-files-found: ignore

      - name: Stop Dashboard Test Server
        if: always()
        run: |
          if [ -f dashboard-dast-server.pid ]; then
            kill "$(cat dashboard-dast-server.pid)" || true
          fi
