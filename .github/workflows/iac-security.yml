name: "ðŸ—ï¸ Infrastructure as Code Security"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================================
  # TERRAFORM SECURITY
  # ============================================================================
  terraform-security:
    name: ðŸŒ Terraform Security Scan
    runs-on: ubuntu-latest
    if: hashFiles('**/*.tf', '**/*.tfvars') != ''
    steps:
      - uses: actions/checkout@v4

      # TFLint - Terraform Linter
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Run TFLint
        run: |
          tflint --init
          tflint --format compact --recursive > tflint-results.txt || true
          cat tflint-results.txt
        continue-on-error: true

      # TFSec - Terraform Security Scanner
      - name: TFSec Scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          format: sarif
          soft_fail: true
          output_file: tfsec.sarif

      - name: Upload TFSec SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: tfsec.sarif
          category: 'tfsec'

      # Checkov for Terraform
      - name: Checkov Terraform Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
          output_format: sarif
          output_file_path: checkov-terraform.sarif
        continue-on-error: true

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-terraform.sarif
          category: 'checkov-terraform'

      - name: Upload Terraform Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-security
          path: |
            tflint-results.txt
            tfsec.sarif
            checkov-terraform.sarif

  # ============================================================================
  # KUBERNETES SECURITY
  # ============================================================================
  kubernetes-security:
    name: â˜¸ï¸ Kubernetes Security Scan
    runs-on: ubuntu-latest
    if: hashFiles('**/*.yaml', '**/*.yml', '**/k8s/**', '**/kubernetes/**') != ''
    steps:
      - uses: actions/checkout@v4

      # KubeLinter
      - name: KubeLinter Scan
        uses: stackrox/kube-linter-action@v1
        with:
          directory: .
          format: sarif
          output-file: kubelinter.sarif
        continue-on-error: true

      - name: Upload KubeLinter SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: kubelinter.sarif
          category: 'kubelinter'

      # Checkov for Kubernetes
      - name: Checkov Kubernetes Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: kubernetes
          output_format: sarif
          output_file_path: checkov-k8s.sarif
        continue-on-error: true

      - name: Upload Checkov K8s Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-k8s.sarif
          category: 'checkov-kubernetes'

      # KICS - Keeping Infrastructure as Code Secure
      - name: KICS Scan
        uses: checkmarx/kics-github-action@v1.7.0
        with:
          path: '.'
          output_path: kics-results
          output_formats: 'sarif'
          platform_type: k8s
          fail_on: high
        continue-on-error: true

      - name: Upload KICS Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: kics-results/results.sarif
          category: 'kics'

      - name: Upload K8s Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kubernetes-security
          path: |
            kubelinter.sarif
            checkov-k8s.sarif
            kics-results/

  # ============================================================================
  # CLOUDFORMATION SECURITY
  # ============================================================================
  cloudformation-security:
    name: â˜ï¸ CloudFormation Security
    runs-on: ubuntu-latest
    if: hashFiles('**/*.template', '**/*.template.json', '**/*.template.yaml') != ''
    steps:
      - uses: actions/checkout@v4

      # CFN-Lint
      - name: CloudFormation Linter
        uses: scottbrenner/cfn-lint-action@v2
        with:
          args: "**/*.template **/*.template.json **/*.template.yaml"

      # Checkov for CloudFormation
      - name: Checkov CloudFormation Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: cloudformation
          output_format: sarif
          output_file_path: checkov-cfn.sarif
        continue-on-error: true

      - name: Upload Checkov CFN Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-cfn.sarif
          category: 'checkov-cloudformation'

  # ============================================================================
  # ANSIBLE SECURITY
  # ============================================================================
  ansible-security:
    name: ðŸ“˜ Ansible Security Scan
    runs-on: ubuntu-latest
    if: hashFiles('**/*.yml', '**/*.yaml', '**/ansible/**', '**/playbooks/**') != ''
    steps:
      - uses: actions/checkout@v4

      - name: Run ansible-lint
        uses: ansible/ansible-lint@main
        with:
          args: "--sarif-file ansible-lint.sarif"
        continue-on-error: true

      - name: Upload Ansible Lint Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ansible-lint.sarif
          category: 'ansible-lint'

  # ============================================================================
  # GENERAL IaC BEST PRACTICES
  # ============================================================================
  iac-best-practices:
    name: ðŸ“‹ IaC Best Practices Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check IaC Best Practices
        run: |
          echo "# Infrastructure as Code Best Practices" > iac-analysis.md
          echo "" >> iac-analysis.md
          
          # Check for hardcoded credentials
          echo "## Security Checks:" >> iac-analysis.md
          echo "### Hardcoded Credentials:" >> iac-analysis.md
          grep -rn "password\|secret\|token\|key" --include="*.tf" --include="*.yaml" --include="*.yml" --include="*.json" . | grep -v "var\." | head -20 >> iac-analysis.md || echo "âœ… No obvious hardcoded credentials" >> iac-analysis.md
          
          # Check for default ports
          echo "" >> iac-analysis.md
          echo "### Exposed Default Ports:" >> iac-analysis.md
          grep -rn "port.*22\|port.*3389\|port.*3306\|port.*5432" --include="*.tf" --include="*.yaml" --include="*.yml" . | head -20 >> iac-analysis.md || echo "âœ… No obvious default port exposures" >> iac-analysis.md
          
          # Check for public accessibility
          echo "" >> iac-analysis.md
          echo "### Public Accessibility:" >> iac-analysis.md
          grep -rn "0.0.0.0/0\|::/0" --include="*.tf" --include="*.yaml" --include="*.yml" . | head -20 >> iac-analysis.md || echo "â„¹ï¸ Check manually for public access" >> iac-analysis.md
          
          # Check for encryption
          echo "" >> iac-analysis.md
          echo "### Encryption Usage:" >> iac-analysis.md
          grep -rn "encrypt\|kms\|tls\|ssl" --include="*.tf" --include="*.yaml" --include="*.yml" . | head -20 >> iac-analysis.md || echo "âš ï¸ Limited encryption configuration found" >> iac-analysis.md
          
          cat iac-analysis.md
        continue-on-error: true

      - name: Upload IaC Analysis
        uses: actions/upload-artifact@v4
        with:
          name: iac-best-practices
          path: iac-analysis.md

  # ============================================================================
  # CONFIGURATION FILE SECURITY
  # ============================================================================
  config-file-security:
    name: ðŸ”§ Configuration File Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan Configuration Files
        run: |
          echo "# Configuration Security Analysis" > config-security.md
          echo "" >> config-security.md
          
          # Check .env files
          echo "## Environment Files:" >> config-security.md
          if find . -name ".env*" -o -name "*.env" | grep -v node_modules | grep .; then
            echo "âš ï¸ WARNING: .env files should not be committed!" >> config-security.md
            find . -name ".env*" -o -name "*.env" | grep -v node_modules >> config-security.md
          else
            echo "âœ… No .env files in repository" >> config-security.md
          fi
          
          # Check config files for secrets
          echo "" >> config-security.md
          echo "## Config File Security:" >> config-security.md
          find . -name "config.*" -o -name "*.config.*" -o -name "settings.*" | while read file; do
            if grep -q "password\|secret\|token\|key" "$file" 2>/dev/null; then
              echo "âš ï¸ Potential secrets in: $file" >> config-security.md
            fi
          done || echo "âœ… No obvious secrets in config files" >> config-security.md
          
          # Check for debug mode
          echo "" >> config-security.md
          echo "## Debug Mode Check:" >> config-security.md
          grep -rn "DEBUG.*=.*True\|debug.*:.*true" --include="*.py" --include="*.js" --include="*.json" --include="*.yaml" . | head -10 >> config-security.md || echo "âœ… No debug mode enabled" >> config-security.md
          
          cat config-security.md
        continue-on-error: true

      - name: Upload Config Security
        uses: actions/upload-artifact@v4
        with:
          name: config-security
          path: config-security.md

  # ============================================================================
  # IAC SUMMARY
  # ============================================================================
  iac-summary:
    name: ðŸ“Š IaC Security Summary
    needs: [terraform-security, kubernetes-security, cloudformation-security, ansible-security, iac-best-practices, config-file-security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create IaC Summary
        run: |
          echo "# ðŸ—ï¸ Infrastructure as Code Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scans Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kubernetes Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CloudFormation Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ansible Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… IaC Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Configuration File Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Review artifacts for detailed security findings**" >> $GITHUB_STEP_SUMMARY
