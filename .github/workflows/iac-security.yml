name: "ðŸ—ï¸ IaC Security (Optimized)"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions: read-all

jobs:
  # ============================================================================
  # DETECT IAC FILES
  # ============================================================================
  detect-iac:
    name: ðŸ” Detect IaC Files
    runs-on: ubuntu-latest
    outputs:
      has_terraform: ${{ steps.check.outputs.has_terraform }}
      has_kubernetes: ${{ steps.check.outputs.has_kubernetes }}
      has_cloudformation: ${{ steps.check.outputs.has_cloudformation }}
      has_any: ${{ steps.check.outputs.has_any }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: Check for IaC Files
        id: check
        run: |
          has_any=false
          
          # Check for Terraform
          if find . -name "*.tf" -o -name "*.tfvars" | grep -q .; then
            echo "has_terraform=true" >> $GITHUB_OUTPUT
            echo "âœ… Terraform files found"
            has_any=true
          else
            echo "has_terraform=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Terraform files"
          fi
          
          # Check for Kubernetes
          if find . -name "*k8s*.yaml" -o -name "*k8s*.yml" -o -path "*/kubernetes/*" | grep -q .; then
            echo "has_kubernetes=true" >> $GITHUB_OUTPUT
            echo "âœ… Kubernetes files found"
            has_any=true
          else
            echo "has_kubernetes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Kubernetes files"
          fi
          
          # Check for CloudFormation
          if find . -name "*.template" -o -name "*.template.json" -o -name "*.template.yaml" | grep -q .; then
            echo "has_cloudformation=true" >> $GITHUB_OUTPUT
            echo "âœ… CloudFormation templates found"
            has_any=true
          else
            echo "has_cloudformation=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No CloudFormation templates"
          fi
          
          echo "has_any=$has_any" >> $GITHUB_OUTPUT

  # ============================================================================
  # IAC SAST SCANNERS (RESTORED CORE COVERAGE)
  # ============================================================================
  iac-sast:
    name: ðŸ”’ IaC SAST Scanners
    needs: detect-iac
    if: needs.detect-iac.outputs.has_any == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Checkov IaC Scan (SARIF)
        uses: bridgecrewio/checkov-action@b3c44b4437c93549fc8cfaef9208497ba4955d39 # master
        with:
          directory: .
          framework: terraform,kubernetes,dockerfile,cloudformation
          output_format: sarif
          output_file_path: checkov-iac.sarif
          soft_fail: true
        continue-on-error: true

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('checkov-iac.sarif') != ''
        with:
          sarif_file: checkov-iac.sarif
          category: checkov-iac
        continue-on-error: true

      - name: tfsec Terraform Scan (SARIF)
        if: needs.detect-iac.outputs.has_terraform == 'true'
        uses: aquasecurity/tfsec-action@b466648d6e39e7c75324f25d83891162a721f2d6 # v1.0.3
        with:
          working_directory: .
          format: sarif
          soft_fail: true
          output_file: tfsec.sarif
        continue-on-error: true

      - name: Upload tfsec SARIF
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('tfsec.sarif') != ''
        with:
          sarif_file: tfsec.sarif
          category: tfsec
        continue-on-error: true

      - name: KubeLinter Scan (SARIF)
        if: needs.detect-iac.outputs.has_kubernetes == 'true'
        uses: stackrox/kube-linter-action@ca0d55b925470deb5b04b556e6c4276ea94d03c3 # v1.0.4
        with:
          directory: .
          format: sarif
          output-file: kubelinter.sarif
        continue-on-error: true

      - name: Upload KubeLinter SARIF
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('kubelinter.sarif') != ''
        with:
          sarif_file: kubelinter.sarif
          category: kubelinter
        continue-on-error: true

      - name: KICS IaC Scan (SARIF)
        uses: checkmarx/kics-github-action@8a44970e3d2eca668be41abe9d4e06709c3b3609 # v1.7.0
        with:
          path: .
          output_path: kics-results
          output_formats: sarif
          fail_on: high
        continue-on-error: true

      - name: Upload KICS SARIF
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('kics-results/results.sarif') != ''
        with:
          sarif_file: kics-results/results.sarif
          category: kics
        continue-on-error: true

      - name: Ansible Lint (SARIF)
        if: hashFiles('**/ansible/**/*.yml', '**/ansible/**/*.yaml', '**/playbook*.yml', '**/playbook*.yaml') != ''
        uses: ansible/ansible-lint@7fe29007f249933300ef40ebbc03ba799c1ff068 # main
        with:
          args: "--sarif-file ansible-lint.sarif"
        continue-on-error: true

      - name: Upload Ansible Lint SARIF
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('ansible-lint.sarif') != ''
        with:
          sarif_file: ansible-lint.sarif
          category: ansible-lint
        continue-on-error: true

      - name: Trivy Config Scan (SARIF)
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          scan-type: config
          scan-ref: .
          format: sarif
          output: trivy-config.sarif
          severity: LOW,MEDIUM,HIGH,CRITICAL
          exit-code: 0
        continue-on-error: true

      - name: Upload Trivy Config SARIF
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('trivy-config.sarif') != ''
        with:
          sarif_file: trivy-config.sarif
          category: trivy-config
        continue-on-error: true

      - name: Upload IaC SAST Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: iac-sast-reports
          path: |
            checkov-iac.sarif
            tfsec.sarif
            kubelinter.sarif
            kics-results/
            ansible-lint.sarif
            trivy-config.sarif
          if-no-files-found: ignore

  # ============================================================================
  # GENERAL IAC BEST PRACTICES (ALWAYS RUNS)
  # ============================================================================
  iac-best-practices:
    name: ðŸ“‹ IaC Best Practices
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Check Best Practices
        run: |
          echo "# Infrastructure Security Analysis" > iac-analysis.md
          echo "" >> iac-analysis.md
          
          # Check for hardcoded credentials in common files
          echo "## Security Checks:" >> iac-analysis.md
          echo "### Potential Hardcoded Credentials:" >> iac-analysis.md
          
          found=0
          for pattern in "password" "secret" "token" "apikey" "api_key"; do
            if grep -rni "$pattern\s*[=:]" . --include="*.yaml" --include="*.yml" --include="*.json" --include="*.tf" 2>/dev/null | grep -v "var\." | grep -v "#" | head -5; then
              found=1
            fi
          done
          
          if [ $found -eq 0 ]; then
            echo "âœ… No obvious hardcoded credentials found" >> iac-analysis.md
          else
            echo "âš ï¸ Potential credentials found - review manually" >> iac-analysis.md
          fi
          
          # Check for .env files (shouldn't be committed)
          echo "" >> iac-analysis.md
          echo "### Environment Files:" >> iac-analysis.md
          if find . -name ".env*" | grep -v node_modules | grep -v ".github" | grep -q .; then
            echo "âš ï¸ WARNING: .env files found in repository!" >> iac-analysis.md
            find . -name ".env*" | grep -v node_modules >> iac-analysis.md
          else
            echo "âœ… No .env files committed" >> iac-analysis.md
          fi
          
          cat iac-analysis.md

      - name: Upload Analysis
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: iac-best-practices
          path: iac-analysis.md
          if-no-files-found: ignore

  # ============================================================================
  # CONFIG FILE SECURITY (ALWAYS RUNS)
  # ============================================================================
  config-security:
    name: ðŸ”§ Configuration Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Scan Config Files
        run: |
          echo "# Configuration Security" > config-security.md
          echo "" >> config-security.md
          
          # Check for debug mode
          echo "## Debug Mode Check:" >> config-security.md
          if grep -rni "debug.*true\|debug.*=.*1" --include="*.py" --include="*.js" --include="*.json" --include="*.yaml" . | grep -v "#" | head -5; then
            echo "âš ï¸ Debug mode might be enabled" >> config-security.md
          else
            echo "âœ… No debug mode detected" >> config-security.md
          fi
          
          # List config files
          echo "" >> config-security.md
          echo "## Configuration Files Found:" >> config-security.md
          find . -name "config.*" -o -name "*.config.*" -o -name "settings.*" 2>/dev/null | head -10 >> config-security.md || echo "None found" >> config-security.md
          
          cat config-security.md

      - name: Upload Config Security
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: config-security
          path: config-security.md
          if-no-files-found: ignore

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: ðŸ“Š IaC Summary
    needs: [detect-iac, iac-sast, iac-best-practices, config-security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "# ðŸ—ï¸ Infrastructure Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## IaC Files Detected:" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform: ${{ needs.detect-iac.outputs.has_terraform == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Kubernetes: ${{ needs.detect-iac.outputs.has_kubernetes == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFormation: ${{ needs.detect-iac.outputs.has_cloudformation == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-iac.outputs.has_any }}" == "false" ]; then
            echo "â„¹ï¸ **No IaC files detected** - only general security checks were performed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **IaC files found** - security analysis completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- IaC SAST: ${{ needs.iac-sast.result == 'success' && 'âœ…' || needs.iac-sast.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Best Practices: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Config Security: âœ…" >> $GITHUB_STEP_SUMMARY
