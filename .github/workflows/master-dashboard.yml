name: "ðŸŽ¯ Master Security & Quality Dashboard"

on:
  schedule:
    - cron: '0 1 * * 1'  # Weekly on Monday at 1 AM
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - security-only
          - performance-only
          - compliance-only

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  # ============================================================================
  # TRIGGER ALL WORKFLOWS
  # ============================================================================
  trigger-security-scan:
    name: ðŸ”’ Trigger Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'security-only' || github.event.inputs.scan_type == ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Trigger Deep Security Scan
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_file_name: security-deep-scan.yml
        continue-on-error: true

  trigger-container-scan:
    name: ðŸ³ Trigger Container Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'security-only' || github.event.inputs.scan_type == ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Trigger Container Security
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_file_name: container-security.yml
        continue-on-error: true

  trigger-iac-scan:
    name: ðŸ—ï¸ Trigger IaC Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'security-only' || github.event.inputs.scan_type == ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Trigger IaC Security
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_file_name: iac-security.yml
        continue-on-error: true

  trigger-performance-scan:
    name: âš¡ Trigger Performance Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'performance-only' || github.event.inputs.scan_type == ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Trigger Performance Analysis
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_file_name: performance-analysis.yml
        continue-on-error: true

  trigger-compliance-scan:
    name: âœ… Trigger Compliance Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'compliance-only' || github.event.inputs.scan_type == ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Trigger Compliance Check
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_file_name: compliance-check.yml
        continue-on-error: true

  # ============================================================================
  # AGGREGATE RESULTS
  # ============================================================================
  aggregate-results:
    name: ðŸ“Š Aggregate All Results
    needs: [trigger-security-scan, trigger-container-scan, trigger-iac-scan, trigger-performance-scan, trigger-compliance-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Generate Comprehensive Dashboard
        run: |
          echo "# ðŸŽ¯ Comprehensive Security & Quality Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ”’ Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deep Security Scan (Python, JS, Secrets)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container Security (Docker, Images)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Infrastructure as Code Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CodeQL Advanced Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency Review & CVE Scanning" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secret Scanning (Gitleaks, Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âš¡ Performance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python Memory & Performance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JavaScript Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database Query Optimization" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API Performance Check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Resource Usage Estimation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âœ… Compliance & Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… License Compliance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Style & Formatting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation Quality" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git Hygiene" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Accessibility Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“ˆ Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Tools Used | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **SAST** | CodeQL, Semgrep, Bandit | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **SCA** | Trivy, Safety, npm audit | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **Secrets** | Gitleaks, Trivy Secrets | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **Container** | Trivy, Hadolint, Dive | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **IaC** | TFSec, Checkov, KICS | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **Performance** | Radon, py-spy, Scalene | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **Compliance** | FOSSA, pip-licenses | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **Quality** | Ruff, ESLint, Black | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Tab](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
          echo "- [Actions](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Insights](https://github.com/${{ github.repository }}/pulse)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **All detailed reports available in workflow artifacts**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # METRICS COLLECTION
  # ============================================================================
  collect-metrics:
    name: ðŸ“Š Collect Security Metrics
    needs: aggregate-results
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Collect and Store Metrics
        run: |
          mkdir -p metrics
          
          # Create metrics report
          cat > metrics/security-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "scan_type": "${{ github.event.inputs.scan_type || 'full' }}",
            "workflows_executed": {
              "security_deep_scan": "${{ needs.trigger-security-scan.result }}",
              "container_security": "${{ needs.trigger-container-scan.result }}",
              "iac_security": "${{ needs.trigger-iac-scan.result }}",
              "performance_analysis": "${{ needs.trigger-performance-scan.result }}",
              "compliance_check": "${{ needs.trigger-compliance-scan.result }}"
            },
            "coverage": {
              "sast": "CodeQL, Semgrep, Bandit",
              "sca": "Trivy, Safety, npm audit",
              "secrets": "Gitleaks, Trivy",
              "container": "Trivy, Hadolint",
              "iac": "TFSec, Checkov, KICS",
              "performance": "Radon, py-spy",
              "compliance": "FOSSA, pip-licenses",
              "quality": "Ruff, ESLint, Black"
            }
          }
          EOF
          
          cat metrics/security-metrics.json

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: security-metrics
          path: metrics/

  # ============================================================================
  # NOTIFICATION
  # ============================================================================
  notify-completion:
    name: ðŸ”” Send Completion Notification
    needs: [aggregate-results, collect-metrics]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Status Badge
        run: |
          echo "## ðŸŽ¯ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security and quality workflows have been executed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the Security tab for any critical findings" >> $GITHUB_STEP_SUMMARY
          echo "2. Download artifacts from individual workflows for detailed reports" >> $GITHUB_STEP_SUMMARY
          echo "3. Address high/critical severity issues first" >> $GITHUB_STEP_SUMMARY
          echo "4. Schedule fixes for medium/low severity items" >> $GITHUB_STEP_SUMMARY
