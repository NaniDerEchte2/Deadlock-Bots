name: "ðŸ”’ Deep Security Scan (Maximum Analysis)"

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
  schedule:
    - cron: '0 2 * * *'  # TÃ¤glich um 2 Uhr nachts
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  # ============================================================================
  # PYTHON SECURITY & QUALITY - MAXIMAL
  # ============================================================================
  python-security:
    name: ðŸ Python Security Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Analysis Tools
        run: |
          pip install --upgrade pip
          pip install bandit[toml] safety pip-audit semgrep radon vulture dodgy pyroma
          pip install pylint mypy ruff prospector

      # Bandit - Security Issues
      - name: Bandit Security Scan
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -ll -i  # Show high/medium issues
        continue-on-error: true

      # Safety - Known Vulnerabilities
      - name: Safety Vulnerability Check
        run: |
          if [ -f requirements.txt ]; then
            safety check --json --output safety-report.json || true
            safety check --full-report
          fi
        continue-on-error: true

      # Pip-Audit - Alternative vulnerability scanner
      - name: Pip-Audit Deep Scan
        run: |
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt --format json --output pip-audit.json || true
            pip-audit -r requirements.txt --desc
          fi
        continue-on-error: true

      # Semgrep - Advanced SAST
      - name: Semgrep SAST Scan
        run: |
          semgrep --config=auto --json --output=semgrep-python.json . || true
          semgrep --config=auto --severity ERROR .
        continue-on-error: true

      # Vulture - Dead Code Detection
      - name: Find Dead Code
        run: |
          vulture . --min-confidence 80 > vulture-report.txt || true
          cat vulture-report.txt
        continue-on-error: true

      # Dodgy - Suspicious Code Patterns
      - name: Check for Dodgy Code
        run: |
          dodgy || true
        continue-on-error: true

      # Radon - Complexity Analysis
      - name: Complexity Analysis
        run: |
          radon cc . -a -nb --total-average > radon-complexity.txt || true
          radon mi . -nb > radon-maintainability.txt || true
          cat radon-complexity.txt
          cat radon-maintainability.txt
        continue-on-error: true

      # Prospector - Combined Analysis
      - name: Prospector Deep Analysis
        run: |
          prospector --output-format json --output prospector.json . || true
          prospector --strictness veryhigh .
        continue-on-error: true

      - name: Upload Python Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit.json
            semgrep-python.json
            vulture-report.txt
            radon-*.txt
            prospector.json

  # ============================================================================
  # JAVASCRIPT/TYPESCRIPT SECURITY - MAXIMAL
  # ============================================================================
  javascript-security:
    name: ðŸ“¦ JavaScript/TypeScript Security Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        if: hashFiles('**/package-lock.json') != ''
        run: npm ci

      # NPM Audit - Maximum Detail
      - name: NPM Audit (Strict)
        if: hashFiles('**/package-lock.json') != ''
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --audit-level=low
        continue-on-error: true

      # Snyk - Vulnerability Scanning
      - name: Snyk Security Scan
        if: hashFiles('**/package-lock.json') != ''
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --detection-depth=6 --severity-threshold=low

      # ESLint Security Plugin
      - name: ESLint Security Scan
        if: hashFiles('**/package.json') != ''
        run: |
          npm install -g eslint eslint-plugin-security eslint-plugin-no-secrets
          eslint . --ext .js,.ts,.jsx,.tsx --format json --output-file eslint-security.json || true
        continue-on-error: true

      # RetireJS - Check for vulnerable JS libraries
      - name: RetireJS Scan
        run: |
          npm install -g retire
          retire --path . --outputformat json --outputpath retirejs-report.json || true
          retire --path . --severity high
        continue-on-error: true

      - name: Upload JS Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: javascript-security-reports
          path: |
            npm-audit.json
            eslint-security.json
            retirejs-report.json

  # ============================================================================
  # TRIVY - MULTI-TARGET SECURITY SCANNER
  # ============================================================================
  trivy-comprehensive:
    name: ðŸ›¡ï¸ Trivy Comprehensive Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Filesystem Scan - Everything
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          scanners: 'vuln,secret,misconfig'

      # Config Files Scan
      - name: Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config.sarif'
          severity: 'LOW,MEDIUM,HIGH,CRITICAL'

      # SBOM Generation
      - name: Generate SBOM
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-filesystem'

      - name: Upload Config Scan
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-config.sarif'
          category: 'trivy-config'

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: software-bom
          path: sbom.json

  # ============================================================================
  # SEMGREP - ADVANCED SAST
  # ============================================================================
  semgrep-pro:
    name: ðŸ” Semgrep Professional SAST
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Semgrep Full Scan
        run: |
          semgrep --config=auto \
                   --config=p/security-audit \
                   --config=p/secrets \
                   --config=p/owasp-top-ten \
                   --config=p/r2c-security-audit \
                   --config=p/r2c-bug-scan \
                   --json --output=semgrep-full.json \
                   --severity ERROR --severity WARNING . || true
        continue-on-error: true

      - name: Semgrep SARIF
        run: |
          semgrep --config=auto \
                   --config=p/security-audit \
                   --config=p/owasp-top-ten \
                   --sarif --output=semgrep.sarif . || true
        continue-on-error: true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: 'semgrep'

      - name: Upload Semgrep Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-reports
          path: semgrep-full.json

  # ============================================================================
  # DEPENDENCY TRACK - FULL DEPENDENCY GRAPH
  # ============================================================================
  dependency-deep-dive:
    name: ðŸ“Š Deep Dependency Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Dependency Graph Visualization
      - name: Generate Dependency Graph
        run: |
          # Python Dependencies
          if [ -f requirements.txt ]; then
            pip install pipdeptree
            pipdeptree --json > python-deps-tree.json
            pipdeptree --graph-output png > python-deps.png || true
          fi
          
          # NPM Dependencies
          if [ -f package.json ]; then
            npm install -g dependency-cruiser
            depcruise --output-type json src > npm-deps.json || true
          fi

      # License Compliance
      - name: License Scanner
        run: |
          if [ -f requirements.txt ]; then
            pip install pip-licenses
            pip-licenses --format=json --with-urls > python-licenses.json
            pip-licenses --format=markdown > python-licenses.md
          fi
          
          if [ -f package.json ]; then
            npm install -g license-checker
            license-checker --json > npm-licenses.json || true
          fi

      - name: Upload Dependency Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-analysis
          path: |
            *-deps*.json
            *-deps*.png
            *-licenses.*

  # ============================================================================
  # CODE QUALITY METRICS
  # ============================================================================
  code-quality-metrics:
    name: ðŸ“ˆ Code Quality Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Python Quality
      - name: Python Quality Checks
        run: |
          pip install radon wily mccabe
          
          # Cyclomatic Complexity
          radon cc . -a --total-average --json > complexity.json
          
          # Maintainability Index
          radon mi . --json > maintainability.json
          
          # Raw Metrics
          radon raw . --json > raw-metrics.json
          
          # Halstead Metrics
          radon hal . --json > halstead.json
        continue-on-error: true

      # Duplicate Code Detection
      - name: Find Code Duplicates
        run: |
          pip install radon
          # Python duplicates
          find . -name "*.py" -exec md5sum {} \; | sort | uniq -w32 -D > duplicates.txt || true
        continue-on-error: true

      # Comment Ratio Analysis
      - name: Comment Coverage Analysis
        run: |
          # Count code lines vs comments
          find . -name "*.py" | xargs wc -l > total-lines.txt || true
          find . -name "*.py" | xargs grep "^[[:space:]]*#" | wc -l > comment-lines.txt || true
        continue-on-error: true

      - name: Upload Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-metrics
          path: |
            complexity.json
            maintainability.json
            raw-metrics.json
            halstead.json
            duplicates.txt
            *-lines.txt

  # ============================================================================
  # SECURITY SCORECARD
  # ============================================================================
  security-scorecard:
    name: ðŸ† OSSF Security Scorecard
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Run Scorecard
        uses: ossf/scorecard-action@v2
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard Results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: scorecard-results.sarif
          category: 'scorecard'

  # ============================================================================
  # FINAL SUMMARY REPORT
  # ============================================================================
  generate-summary:
    name: ðŸ“‹ Generate Security Summary
    needs: [python-security, javascript-security, trivy-comprehensive, semgrep-pro, dependency-deep-dive, code-quality-metrics, security-scorecard]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download All Reports
        uses: actions/download-artifact@v4

      - name: Create Summary Report
        run: |
          echo "# ðŸ”’ Security & Quality Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Analysis Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python Security Suite" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JavaScript/TypeScript Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trivy Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Semgrep SAST Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deep Dependency Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OSSF Security Scorecard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **All artifacts uploaded for review**" >> $GITHUB_STEP_SUMMARY
