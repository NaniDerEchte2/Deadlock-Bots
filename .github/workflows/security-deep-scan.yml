name: "ðŸ”’ Deep Security Scan (Optimized)"

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  # ============================================================================
  # CHECK WHAT'S AVAILABLE
  # ============================================================================
  detect-languages:
    name: ðŸ” Detect Project Structure
    runs-on: ubuntu-latest
    outputs:
      has_python: ${{ steps.check.outputs.has_python }}
      has_javascript: ${{ steps.check.outputs.has_javascript }}
      has_requirements: ${{ steps.check.outputs.has_requirements }}
      has_package_json: ${{ steps.check.outputs.has_package_json }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Project Structure
        id: check
        run: |
          # Check for Python files
          if find . -name "*.py" -type f | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
            echo "âœ… Python files detected"
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Python files found"
          fi
          
          # Check for JS/TS files
          if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -q .; then
            echo "has_javascript=true" >> $GITHUB_OUTPUT
            echo "âœ… JavaScript/TypeScript files detected"
          else
            echo "has_javascript=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No JavaScript files found"
          fi
          
          # Check for requirements.txt
          if [ -f requirements.txt ]; then
            echo "has_requirements=true" >> $GITHUB_OUTPUT
            echo "âœ… requirements.txt found"
          else
            echo "has_requirements=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No requirements.txt found"
          fi
          
          # Check for package.json
          if [ -f package.json ]; then
            echo "has_package_json=true" >> $GITHUB_OUTPUT
            echo "âœ… package.json found"
          else
            echo "has_package_json=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No package.json found"
          fi

  # ============================================================================
  # PYTHON SECURITY - ONLY IF PYTHON EXISTS
  # ============================================================================
  python-security:
    name: ðŸ Python Security Suite
    needs: detect-languages
    if: needs.detect-languages.outputs.has_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Analysis Tools
        run: |
          pip install --upgrade pip
          pip install bandit safety pip-audit radon vulture
        continue-on-error: true

      # Bandit - Security Issues
      - name: Bandit Security Scan
        run: |
          echo "Running Bandit security scan..."
          bandit -r . -f json -o bandit-report.json -ll || true
          if [ -f bandit-report.json ]; then
            echo "âœ… Bandit scan completed"
            bandit -r . -ll || echo "âš ï¸ Security issues found (check artifact)"
          fi
        continue-on-error: true

      # Safety - Known Vulnerabilities (only if requirements.txt exists)
      - name: Safety Vulnerability Check
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          echo "Running Safety vulnerability check..."
          safety check --json --output safety-report.json || true
          if [ -f safety-report.json ]; then
            echo "âœ… Safety check completed"
            safety check --full-report || echo "âš ï¸ Vulnerabilities found (check artifact)"
          fi
        continue-on-error: true

      # Pip-Audit (only if requirements.txt exists)
      - name: Pip-Audit Deep Scan
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          echo "Running pip-audit..."
          pip-audit -r requirements.txt --format json --output pip-audit.json || true
          if [ -f pip-audit.json ]; then
            echo "âœ… Pip-audit completed"
          fi
        continue-on-error: true

      # Radon - Complexity Analysis
      - name: Complexity Analysis
        run: |
          echo "Running complexity analysis..."
          radon cc . -a -nb --total-average > radon-complexity.txt || true
          radon mi . -nb > radon-maintainability.txt || true
          echo "âœ… Complexity analysis completed"
        continue-on-error: true

      # Vulture - Dead Code Detection
      - name: Find Dead Code
        run: |
          echo "Looking for dead code..."
          vulture . --min-confidence 80 > vulture-report.txt || true
          if [ -f vulture-report.txt ]; then
            lines=$(wc -l < vulture-report.txt)
            echo "Found $lines potential dead code items"
          fi
        continue-on-error: true

      - name: Upload Python Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit.json
            radon-*.txt
            vulture-report.txt
          if-no-files-found: ignore

  # ============================================================================
  # JAVASCRIPT SECURITY - ONLY IF JS/TS EXISTS
  # ============================================================================
  javascript-security:
    name: ðŸ“¦ JavaScript/TypeScript Security
    needs: detect-languages
    if: needs.detect-languages.outputs.has_javascript == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # NPM Audit - Only if package-lock.json exists
      - name: NPM Audit
        if: hashFiles('**/package-lock.json') != ''
        run: |
          echo "Running NPM audit..."
          npm audit --json > npm-audit.json || true
          if [ -f npm-audit.json ]; then
            echo "âœ… NPM audit completed"
            npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilities found"
          fi
        continue-on-error: true

      # RetireJS - Check for vulnerable JS libraries
      - name: RetireJS Scan
        run: |
          npm install -g retire || true
          echo "Running RetireJS scan..."
          retire --path . --outputformat json --outputpath retirejs-report.json || true
          if [ -f retirejs-report.json ]; then
            echo "âœ… RetireJS scan completed"
          fi
        continue-on-error: true

      - name: Upload JS Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: javascript-security-reports
          path: |
            npm-audit.json
            retirejs-report.json
          if-no-files-found: ignore

  # ============================================================================
  # TRIVY - FILESYSTEM SCAN (ALWAYS RUNS)
  # ============================================================================
  trivy-scan:
    name: ðŸ›¡ï¸ Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Filesystem Scan
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: 0
        continue-on-error: true

      - name: Upload Trivy Results to Security Tab
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-fs.sarif') != ''
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-filesystem'
        continue-on-error: true

      - name: Upload Trivy Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-reports
          path: trivy-fs.sarif
          if-no-files-found: ignore

  # ============================================================================
  # DEPENDENCY ANALYSIS (ALWAYS RUNS)
  # ============================================================================
  dependency-analysis:
    name: ðŸ“Š Dependency Analysis
    needs: detect-languages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python Dependencies
      - name: Python Dependency Tree
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          pip install pipdeptree
          pipdeptree --json > python-deps-tree.json || true
          pipdeptree || true
        continue-on-error: true

      # License Scanner for Python
      - name: Python License Scanner
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          pip install pip-licenses
          pip install -r requirements.txt || true
          pip-licenses --format=json --with-urls > python-licenses.json || true
          pip-licenses --format=markdown > python-licenses.md || true
        continue-on-error: true

      # NPM License Check
      - name: NPM License Scanner
        if: needs.detect-languages.outputs.has_package_json == 'true' && hashFiles('**/package-lock.json') != ''
        run: |
          npm install -g license-checker
          license-checker --json > npm-licenses.json || true
          license-checker --summary || true
        continue-on-error: true

      - name: Upload Dependency Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-analysis
          path: |
            *-deps*.json
            *-licenses.*
          if-no-files-found: ignore

  # ============================================================================
  # SUMMARY
  # ============================================================================
  generate-summary:
    name: ðŸ“‹ Generate Summary
    needs: [detect-languages, python-security, javascript-security, trivy-scan, dependency-analysis]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "# ðŸ”’ Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Project Detection:" >> $GITHUB_STEP_SUMMARY
          echo "- Python: ${{ needs.detect-languages.outputs.has_python == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript: ${{ needs.detect-languages.outputs.has_javascript == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- requirements.txt: ${{ needs.detect-languages.outputs.has_requirements == 'true' && 'âœ… Found' || 'âŒ Not found' }}" >> $GITHUB_STEP_SUMMARY
          echo "- package.json: ${{ needs.detect-languages.outputs.has_package_json == 'true' && 'âœ… Found' || 'âŒ Not found' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scans Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- Python Security: ${{ needs.python-security.result == 'success' && 'âœ…' || needs.python-security.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript Security: ${{ needs.javascript-security.result == 'success' && 'âœ…' || needs.javascript-security.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Scan: ${{ needs.trivy-scan.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Analysis: ${{ needs.dependency-analysis.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Check artifacts for detailed reports**" >> $GITHUB_STEP_SUMMARY
