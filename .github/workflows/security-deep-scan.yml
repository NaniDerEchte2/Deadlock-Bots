name: "ðŸ”’ Deep Security Scan (Optimized)"

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions: read-all

jobs:
  # ============================================================================
  # CHECK WHAT'S AVAILABLE
  # ============================================================================
  detect-languages:
    name: ðŸ” Detect Project Structure
    runs-on: ubuntu-latest
    outputs:
      has_python: ${{ steps.check.outputs.has_python }}
      has_javascript: ${{ steps.check.outputs.has_javascript }}
      has_requirements: ${{ steps.check.outputs.has_requirements }}
      has_package_json: ${{ steps.check.outputs.has_package_json }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: Check Project Structure
        id: check
        run: |
          # Check for Python files
          if find . -name "*.py" -type f | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
            echo "âœ… Python files detected"
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Python files found"
          fi
          
          # Check for JS/TS files
          if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -q .; then
            echo "has_javascript=true" >> $GITHUB_OUTPUT
            echo "âœ… JavaScript/TypeScript files detected"
          else
            echo "has_javascript=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No JavaScript files found"
          fi
          
          # Check for Python dependency manifests recursively
          if find . -type f -name "requirements*.txt" \
            -not -path "*/.venv/*" \
            -not -path "*/venv/*" \
            -not -path "*/.git/*" | grep -q .; then
            echo "has_requirements=true" >> $GITHUB_OUTPUT
            echo "âœ… requirements*.txt files found"
          else
            echo "has_requirements=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No requirements*.txt files found"
          fi
          
          # Check for package.json recursively
          if find . -type f -name "package.json" \
            -not -path "*/node_modules/*" \
            -not -path "*/.git/*" | grep -q .; then
            echo "has_package_json=true" >> $GITHUB_OUTPUT
            echo "âœ… package.json files found"
          else
            echo "has_package_json=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No package.json files found"
          fi

  # ============================================================================
  # PYTHON SECURITY - ONLY IF PYTHON EXISTS
  # ============================================================================
  python-security:
    name: ðŸ Python Security Suite
    needs: detect-languages
    if: needs.detect-languages.outputs.has_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Install Analysis Tools
        run: |
          python -m pip install \
            bandit==1.9.3 \
            safety==3.7.0 \
            pip-audit==2.10.0 \
            radon==6.0.1 \
            vulture==2.14 \
            dodgy==0.2.1
        continue-on-error: true

      # Bandit - Security Issues
      - name: Bandit Security Scan
        run: |
          echo "Running Bandit security scan..."
          bandit -r . -f json -o bandit-report.json -ll || true
          if [ -f bandit-report.json ]; then
            echo "âœ… Bandit scan completed"
            bandit -r . -ll || echo "âš ï¸ Security issues found (check artifact)"
          fi
        continue-on-error: true

      # Safety - Known Vulnerabilities (recursive requirements scan)
      - name: Safety Vulnerability Check
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          echo "Running Safety vulnerability check (recursive requirements scan)..."
          mkdir -p safety-reports
          found=0
          while IFS= read -r req_file; do
            found=1
            rel_path="${req_file#./}"
            safe_name="$(echo "$rel_path" | sed 's#[^A-Za-z0-9._-]#_#g')"
            echo "Safety scan for $req_file"
            safety check -r "$req_file" --json > "safety-reports/${safe_name}.json" || true
          done < <(find . -type f -name "requirements*.txt" \
            -not -path "*/.venv/*" \
            -not -path "*/venv/*" \
            -not -path "*/.git/*" | sort)

          if [ "$found" -eq 0 ]; then
            echo "â„¹ï¸ No requirements*.txt files found for Safety scan"
          else
            echo "âœ… Safety recursive scan completed"
          fi
        continue-on-error: true

      # Pip-Audit (recursive requirements scan)
      - name: Pip-Audit Deep Scan
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          echo "Running pip-audit (recursive requirements scan)..."
          mkdir -p pip-audit-reports
          found=0
          while IFS= read -r req_file; do
            found=1
            rel_path="${req_file#./}"
            safe_name="$(echo "$rel_path" | sed 's#[^A-Za-z0-9._-]#_#g')"
            echo "pip-audit for $req_file"
            pip-audit -r "$req_file" --format json --output "pip-audit-reports/${safe_name}.json" || true
          done < <(find . -type f -name "requirements*.txt" \
            -not -path "*/.venv/*" \
            -not -path "*/venv/*" \
            -not -path "*/.git/*" | sort)

          if [ "$found" -eq 0 ]; then
            echo "â„¹ï¸ No requirements*.txt files found for pip-audit"
          else
            echo "âœ… Pip-audit recursive scan completed"
          fi
        continue-on-error: true

      # Radon - Complexity Analysis
      - name: Complexity Analysis
        run: |
          echo "Running complexity analysis..."
          radon cc . -a -nb --total-average > radon-complexity.txt || true
          radon mi . -nb > radon-maintainability.txt || true
          echo "âœ… Complexity analysis completed"
        continue-on-error: true

      # Vulture - Dead Code Detection
      - name: Find Dead Code
        run: |
          echo "Looking for dead code..."
          vulture . --min-confidence 80 > vulture-report.txt || true
          if [ -f vulture-report.txt ]; then
            lines=$(wc -l < vulture-report.txt)
            echo "Found $lines potential dead code items"
          fi
        continue-on-error: true

      # Dodgy - Suspicious code patterns
      - name: Dodgy Suspicious Pattern Check
        run: |
          echo "Running dodgy..."
          dodgy > dodgy-report.txt || true
        continue-on-error: true

      - name: Upload Python Security Reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            safety-reports/*.json
            pip-audit-reports/*.json
            radon-*.txt
            vulture-report.txt
            dodgy-report.txt
          if-no-files-found: ignore

  # ============================================================================
  # JAVASCRIPT SECURITY - ONLY IF JS/TS EXISTS
  # ============================================================================
  javascript-security:
    name: ðŸ“¦ JavaScript/TypeScript Security
    needs: detect-languages
    if: needs.detect-languages.outputs.has_javascript == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'

      - name: Property-Based Fuzzing (fast-check)
        if: hashFiles('cogs/steam/steam_presence/fuzz/*.js') != ''
        run: |
          npm ci --prefix cogs/steam/steam_presence --include=dev --ignore-scripts
          npm --prefix cogs/steam/steam_presence run fuzz:protocol

      # NPM Audit - recursive lockfile scan
      - name: NPM Audit
        if: hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json') != ''
        run: |
          echo "Running NPM audit (recursive lockfile scan)..."
          mkdir -p npm-audit-reports
          found=0
          while IFS= read -r lock_file; do
            found=1
            dir_path="$(dirname "$lock_file")"
            rel_dir="${dir_path#./}"
            safe_name="$(echo "${rel_dir:-root}" | sed 's#[^A-Za-z0-9._-]#_#g')"
            echo "NPM audit for $dir_path"
            (
              cd "$dir_path"
              npm audit --json > "$GITHUB_WORKSPACE/npm-audit-reports/${safe_name}.json" || true
            )
          done < <(find . -type f \( -name "package-lock.json" -o -name "npm-shrinkwrap.json" \) \
            -not -path "*/node_modules/*" \
            -not -path "*/.git/*" | sort)

          if [ "$found" -eq 0 ]; then
            echo "â„¹ï¸ No npm lockfiles found for recursive audit"
          else
            echo "âœ… NPM recursive audit completed"
          fi
        continue-on-error: true

      # RetireJS - Check for vulnerable JS libraries
      - name: RetireJS Scan
        run: |
          npm install -g retire@5.4.2 || true
          echo "Running RetireJS scan..."
          retire --path . --outputformat json --outputpath retirejs-report.json || true
          if [ -f retirejs-report.json ]; then
            echo "âœ… RetireJS scan completed"
          fi
        continue-on-error: true

      # ESLint Security Plugin
      - name: ESLint Security Scan
        if: hashFiles('**/package.json') != ''
        run: |
          npm install -g eslint@10.0.0 eslint-plugin-security@3.0.1 eslint-plugin-no-secrets@2.2.2 || true
          eslint . --ext .js,.ts,.jsx,.tsx --format json --output-file eslint-security.json || true
        continue-on-error: true

      # Snyk Scan (optional, requires repository secret SNYK_TOKEN)
      - name: Snyk Security Scan
        if: hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json') != ''
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "${SNYK_TOKEN:-}" ]; then
            echo "â„¹ï¸ SNYK_TOKEN not configured; skipping Snyk scan."
            exit 0
          fi
          npm install -g snyk@1.1302.1 || true
          snyk auth "$SNYK_TOKEN" || true
          snyk test --all-projects --severity-threshold=low --json-file-output=snyk-report.json || true
        continue-on-error: true

      - name: Upload JS Security Reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: javascript-security-reports
          path: |
            npm-audit-reports/*.json
            retirejs-report.json
            eslint-security.json
            snyk-report.json
          if-no-files-found: ignore

  # ============================================================================
  # SEMGREP SAST - KEEPS GITHUB CODE SCANNING ALERTS IN SYNC
  # ============================================================================
  semgrep-sast:
    name: ðŸ” Semgrep OSS SAST
    needs: detect-languages
    if: needs.detect-languages.outputs.has_python == 'true' || needs.detect-languages.outputs.has_javascript == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    container:
      image: semgrep/semgrep:1.151.0
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Semgrep (JSON)
        run: |
          semgrep scan \
            --config auto \
            --json \
            --output semgrep.json \
            --exclude .venv \
            --exclude venv \
            --exclude node_modules \
            --exclude dist \
            --exclude build \
            . || true
        continue-on-error: true

      - name: Run Semgrep (SARIF for Code Scanning)
        run: |
          semgrep scan \
            --config auto \
            --sarif \
            --output semgrep.sarif \
            --exclude .venv \
            --exclude venv \
            --exclude node_modules \
            --exclude dist \
            --exclude build \
            . || true
        continue-on-error: true

      - name: Run Semgrep (Custom Auth Header Guardrails)
        if: hashFiles('.semgrep/rules/*.yml', '.semgrep/rules/*.yaml') != ''
        run: |
          semgrep scan \
            --config .semgrep/rules \
            --sarif \
            --output semgrep-custom.sarif \
            --exclude .venv \
            --exclude venv \
            --exclude node_modules \
            --exclude dist \
            --exclude build \
            . || true
        continue-on-error: true

      - name: Upload Semgrep Results to Security Tab
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('semgrep.sarif') != ''
        with:
          sarif_file: semgrep.sarif
          # Keep the historical category stable so existing Semgrep alerts can auto-close.
          category: semgrep
        continue-on-error: true

      - name: Upload Custom Semgrep Results to Security Tab
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('semgrep-custom.sarif') != ''
        with:
          sarif_file: semgrep-custom.sarif
          category: semgrep-custom-auth
        continue-on-error: true

      - name: Upload Semgrep Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: semgrep-reports
          path: |
            semgrep.json
            semgrep.sarif
            semgrep-custom.sarif
          if-no-files-found: ignore

  # ============================================================================
  # TRIVY - FILESYSTEM SCAN (ALWAYS RUNS)
  # ============================================================================
  trivy-scan:
    name: ðŸ›¡ï¸ Trivy Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      # Filesystem Scan
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: 0
        continue-on-error: true

      - name: Upload Trivy Results to Security Tab
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('trivy-fs.sarif') != ''
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-filesystem'
        continue-on-error: true

      - name: Upload Trivy Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: trivy-reports
          path: trivy-fs.sarif
          if-no-files-found: ignore

  # ============================================================================
  # DEPENDENCY ANALYSIS (ALWAYS RUNS)
  # ============================================================================
  dependency-analysis:
    name: ðŸ“Š Dependency Analysis
    needs: detect-languages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        if: needs.detect-languages.outputs.has_requirements == 'true'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Setup Node.js
        if: needs.detect-languages.outputs.has_package_json == 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'

      # Python dependency manifests (no dynamic package install in CI)
      - name: Python Dependency Manifest Snapshot
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          mkdir -p dependency-analysis/python-deps
          found=0
          while IFS= read -r req_file; do
            found=1
            rel_path="${req_file#./}"
            safe_name="$(echo "$rel_path" | sed 's#[^A-Za-z0-9._-]#_#g')"
            cp "$req_file" "dependency-analysis/python-deps/${safe_name}.requirements.txt"
            awk '
              /^[[:space:]]*#/ || /^[[:space:]]*$/ { next }
              { total += 1 }
              /==/ { pinned += 1 }
              END {
                printf("total_entries=%d\n", total)
                printf("pinned_entries=%d\n", pinned)
                if (total > 0) {
                  printf("pinning_ratio=%.2f\n", pinned / total)
                } else {
                  printf("pinning_ratio=1.00\n")
                }
              }
            ' "$req_file" > "dependency-analysis/python-deps/${safe_name}.pinning.txt"
          done < <(find . -type f -name "requirements*.txt" \
            -not -path "*/.venv/*" \
            -not -path "*/venv/*" \
            -not -path "*/.git/*" | sort)
          if [ "$found" -eq 0 ]; then
            echo "â„¹ï¸ No requirements*.txt files found for dependency manifest snapshot"
          fi
        continue-on-error: true

      - name: Python Dependency Vulnerability Report
        if: needs.detect-languages.outputs.has_requirements == 'true'
        run: |
          python -m pip install pip-audit==2.10.0
          mkdir -p dependency-analysis/python-vulns
          found=0
          while IFS= read -r req_file; do
            found=1
            rel_path="${req_file#./}"
            safe_name="$(echo "$rel_path" | sed 's#[^A-Za-z0-9._-]#_#g')"
            pip-audit -r "$req_file" --format json --output "dependency-analysis/python-vulns/${safe_name}.pip-audit.json" || true
          done < <(find . -type f -name "requirements*.txt" \
            -not -path "*/.venv/*" \
            -not -path "*/venv/*" \
            -not -path "*/.git/*" | sort)
          if [ "$found" -eq 0 ]; then
            echo "â„¹ï¸ No requirements*.txt files found for Python vulnerability reporting"
          fi
        continue-on-error: true

      # NPM License Check
      - name: NPM License Scanner
        if: needs.detect-languages.outputs.has_package_json == 'true' && hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json') != ''
        run: |
          npm install -g license-checker@25.0.1
          mkdir -p dependency-analysis/npm-licenses
          found=0
          while IFS= read -r lock_file; do
            found=1
            dir_path="$(dirname "$lock_file")"
            rel_dir="${dir_path#./}"
            safe_name="$(echo "${rel_dir:-root}" | sed 's#[^A-Za-z0-9._-]#_#g')"
            (
              cd "$dir_path"
              license-checker --json > "$GITHUB_WORKSPACE/dependency-analysis/npm-licenses/${safe_name}.json" || true
              license-checker --summary > "$GITHUB_WORKSPACE/dependency-analysis/npm-licenses/${safe_name}.txt" || true
            )
          done < <(find . -type f \( -name "package-lock.json" -o -name "npm-shrinkwrap.json" \) \
            -not -path "*/node_modules/*" \
            -not -path "*/.git/*" | sort)
          if [ "$found" -eq 0 ]; then
            echo "â„¹ï¸ No npm lockfiles found for license scan"
          fi
        continue-on-error: true

      - name: Upload Dependency Reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: dependency-analysis
          path: |
            dependency-analysis/
          if-no-files-found: ignore

  # ============================================================================
  # OSSF SCORECARD (RESTORED)
  # ============================================================================
  security-scorecard:
    name: ðŸ† OSSF Security Scorecard
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Run Scorecard
        uses: ossf/scorecard-action@f2ea147fec3c2f0d459703eba7405b5e9bcd8c8f # v2.4.2
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true
        continue-on-error: true

      - name: Upload Scorecard SARIF
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always() && hashFiles('scorecard-results.sarif') != ''
        with:
          sarif_file: scorecard-results.sarif
          category: scorecard
        continue-on-error: true

      - name: Upload Scorecard Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: scorecard-report
          path: scorecard-results.sarif
          if-no-files-found: ignore

  # ============================================================================
  # SUMMARY
  # ============================================================================
  generate-summary:
    name: ðŸ“‹ Generate Summary
    needs: [detect-languages, python-security, javascript-security, semgrep-sast, trivy-scan, dependency-analysis, security-scorecard]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "# ðŸ”’ Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Project Detection:" >> $GITHUB_STEP_SUMMARY
          echo "- Python: ${{ needs.detect-languages.outputs.has_python == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript: ${{ needs.detect-languages.outputs.has_javascript == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- requirements*.txt: ${{ needs.detect-languages.outputs.has_requirements == 'true' && 'âœ… Found' || 'âŒ Not found' }}" >> $GITHUB_STEP_SUMMARY
          echo "- package.json: ${{ needs.detect-languages.outputs.has_package_json == 'true' && 'âœ… Found' || 'âŒ Not found' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scans Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- Python Security: ${{ needs.python-security.result == 'success' && 'âœ…' || needs.python-security.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript Security: ${{ needs.javascript-security.result == 'success' && 'âœ…' || needs.javascript-security.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Semgrep SAST: ${{ needs.semgrep-sast.result == 'success' && 'âœ…' || needs.semgrep-sast.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Scan: ${{ needs.trivy-scan.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Analysis: ${{ needs.dependency-analysis.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- OSSF Scorecard: ${{ needs.security-scorecard.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Check artifacts for detailed reports**" >> $GITHUB_STEP_SUMMARY
