name: "ðŸ¤– Dependabot Auto-Merge"

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot-automerge:
    if: >
      github.event.pull_request.draft == false &&
      github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Approve Dependabot PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            if (pr.head.repo.full_name !== `${owner}/${repo}`) {
              core.info("PR comes from a fork; skipping.");
              return;
            }

            try {
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number: pr.number,
                event: "APPROVE",
                body: "Dependabot PR auto-approved."
              });
              core.info(`Approved PR #${pr.number}.`);
            } catch (e) {
              core.info(`Approve skipped: ${e.message}`);
            }

      - name: Enable auto-merge (squash)
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const allowedBases = new Set(["main", "master", "develop"]);

            if (pr.head.repo.full_name !== `${owner}/${repo}`) {
              core.info("PR comes from a fork; skipping auto-merge.");
              return;
            }

            if (!allowedBases.has(pr.base.ref)) {
              core.info(`Base branch ${pr.base.ref} is not allowed for auto-merge.`);
              return;
            }

            try {
              await github.graphql(
                `
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }) {
                    pullRequest {
                      number
                    }
                  }
                }
                `,
                { pullRequestId: pr.node_id }
              );
              core.info(`Enabled auto-merge for PR #${pr.number}.`);
            } catch (e) {
              core.info(`Auto-merge not enabled: ${e.message}`);
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: pr.number,
                  merge_method: "squash"
                });
                core.info(`Merged PR #${pr.number} directly.`);
              } catch (mergeErr) {
                core.info(`Direct merge not possible yet: ${mergeErr.message}`);
              }
            }
