name: "âœ… Compliance & Best Practices"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================================
  # LICENSE COMPLIANCE
  # ============================================================================
  license-compliance:
    name: ðŸ“œ License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Python License Check
      - name: Python License Scanner
        run: |
          pip install pip-licenses licensecheck
          
          echo "# License Compliance Report" > license-report.md
          echo "" >> license-report.md
          
          if [ -f requirements.txt ]; then
            echo "## Python Licenses:" >> license-report.md
            pip install -r requirements.txt
            pip-licenses --format=markdown --with-urls --with-description >> license-report.md
            
            echo "" >> license-report.md
            echo "## Potential License Issues:" >> license-report.md
            # Flag GPL and AGPL licenses
            pip-licenses | grep -E "GPL|AGPL" >> license-report.md || echo "âœ… No GPL/AGPL licenses found" >> license-report.md
          fi
          
          cat license-report.md
        continue-on-error: true

      # Node License Check
      - name: Node License Scanner
        if: hashFiles('**/package.json') != ''
        run: |
          npm install -g license-checker license-compliance
          
          if [ -f package.json ]; then
            echo "" >> license-report.md
            echo "## Node.js Licenses:" >> license-report.md
            license-checker --json > npm-licenses.json || true
            license-checker --summary >> license-report.md || true
            
            echo "" >> license-report.md
            echo "## Restricted Licenses:" >> license-report.md
            license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC" --summary >> license-report.md || echo "âš ï¸ Some dependencies have non-permissive licenses" >> license-report.md
          fi
        continue-on-error: true

      # FOSSA License Scan
      - name: FOSSA Scan
        uses: fossas/fossa-action@main
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}
        continue-on-error: true

      - name: Upload License Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-compliance
          path: |
            license-report.md
            npm-licenses.json

  # ============================================================================
  # CODE STYLE & FORMATTING
  # ============================================================================
  code-style:
    name: ðŸŽ¨ Code Style & Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python Style Checks
      - name: Python Code Style
        run: |
          pip install black ruff isort flake8 pydocstyle
          
          echo "# Code Style Report" > style-report.md
          echo "" >> style-report.md
          
          # Black formatting check
          echo "## Python Formatting (Black):" >> style-report.md
          black --check --diff . >> style-report.md 2>&1 || echo "âš ï¸ Code not formatted with Black" >> style-report.md
          
          # Ruff linting
          echo "" >> style-report.md
          echo "## Python Linting (Ruff):" >> style-report.md
          ruff check . --output-format=text >> style-report.md || true
          
          # isort import sorting
          echo "" >> style-report.md
          echo "## Import Sorting (isort):" >> style-report.md
          isort --check-only --diff . >> style-report.md 2>&1 || echo "âš ï¸ Imports not sorted" >> style-report.md
          
          # Flake8
          echo "" >> style-report.md
          echo "## Flake8 Checks:" >> style-report.md
          flake8 --max-line-length=100 --statistics . >> style-report.md || true
          
          # Docstring coverage
          echo "" >> style-report.md
          echo "## Docstring Coverage:" >> style-report.md
          pydocstyle . >> style-report.md 2>&1 || echo "âš ï¸ Missing or incorrect docstrings" >> style-report.md
          
          cat style-report.md
        continue-on-error: true

      # JavaScript/TypeScript Style
      - name: JS/TS Code Style
        if: hashFiles('**/package.json') != ''
        run: |
          npm install -g prettier eslint
          
          echo "" >> style-report.md
          echo "## JavaScript/TypeScript Formatting:" >> style-report.md
          
          # Prettier check
          prettier --check "**/*.{js,ts,jsx,tsx}" >> style-report.md 2>&1 || echo "âš ï¸ Code not formatted with Prettier" >> style-report.md
          
          # ESLint
          echo "" >> style-report.md
          echo "## ESLint Checks:" >> style-report.md
          eslint . --ext .js,.ts,.jsx,.tsx >> style-report.md 2>&1 || echo "âš ï¸ ESLint violations found" >> style-report.md
        continue-on-error: true

      - name: Upload Style Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-style
          path: style-report.md

  # ============================================================================
  # DOCUMENTATION QUALITY
  # ============================================================================
  documentation-check:
    name: ðŸ“š Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Documentation
        run: |
          echo "# Documentation Quality Report" > docs-report.md
          echo "" >> docs-report.md
          
          # Check for README
          echo "## Essential Documentation:" >> docs-report.md
          if [ -f README.md ]; then
            echo "âœ… README.md exists" >> docs-report.md
            lines=$(wc -l < README.md)
            if [ $lines -lt 10 ]; then
              echo "âš ï¸ README is very short ($lines lines)" >> docs-report.md
            else
              echo "âœ… README has $lines lines" >> docs-report.md
            fi
          else
            echo "âŒ No README.md found" >> docs-report.md
          fi
          
          # Check for CONTRIBUTING guide
          if [ -f CONTRIBUTING.md ] || [ -f .github/CONTRIBUTING.md ]; then
            echo "âœ… CONTRIBUTING guide exists" >> docs-report.md
          else
            echo "âš ï¸ No CONTRIBUTING guide found" >> docs-report.md
          fi
          
          # Check for LICENSE
          if [ -f LICENSE ] || [ -f LICENSE.md ] || [ -f LICENSE.txt ]; then
            echo "âœ… LICENSE file exists" >> docs-report.md
          else
            echo "âŒ No LICENSE file found" >> docs-report.md
          fi
          
          # Check for CODE_OF_CONDUCT
          if [ -f CODE_OF_CONDUCT.md ] || [ -f .github/CODE_OF_CONDUCT.md ]; then
            echo "âœ… Code of Conduct exists" >> docs-report.md
          else
            echo "âš ï¸ No Code of Conduct found" >> docs-report.md
          fi
          
          # Check for SECURITY policy
          if [ -f SECURITY.md ] || [ -f .github/SECURITY.md ]; then
            echo "âœ… Security policy exists" >> docs-report.md
          else
            echo "âš ï¸ No Security policy found" >> docs-report.md
          fi
          
          # Check for docs folder
          echo "" >> docs-report.md
          echo "## Documentation Structure:" >> docs-report.md
          if [ -d docs ]; then
            echo "âœ… /docs folder exists" >> docs-report.md
            doc_count=$(find docs -name "*.md" | wc -l)
            echo "   - Found $doc_count markdown files" >> docs-report.md
          else
            echo "âš ï¸ No /docs folder found" >> docs-report.md
          fi
          
          # Check inline code documentation
          echo "" >> docs-report.md
          echo "## Inline Documentation:" >> docs-report.md
          
          # Python docstrings
          py_files=$(find . -name "*.py" | wc -l)
          if [ $py_files -gt 0 ]; then
            echo "Python files: $py_files" >> docs-report.md
            # Count docstrings
            docstrings=$(grep -r '"""' --include="*.py" . | wc -l)
            echo "Docstrings found: $docstrings" >> docs-report.md
          fi
          
          # JS/TS comments
          js_files=$(find . -name "*.js" -o -name "*.ts" | wc -l)
          if [ $js_files -gt 0 ]; then
            echo "JS/TS files: $js_files" >> docs-report.md
            comments=$(grep -r '/\*\*' --include="*.js" --include="*.ts" . | wc -l)
            echo "JSDoc comments found: $comments" >> docs-report.md
          fi
          
          cat docs-report.md
        continue-on-error: true

      - name: Upload Documentation Report
        uses: actions/upload-artifact@v4
        with:
          name: documentation-quality
          path: docs-report.md

  # ============================================================================
  # GIT BEST PRACTICES
  # ============================================================================
  git-hygiene:
    name: ðŸ”€ Git Hygiene Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Git Best Practices
        run: |
          echo "# Git Hygiene Report" > git-report.md
          echo "" >> git-report.md
          
          # Check .gitignore
          echo "## .gitignore Check:" >> git-report.md
          if [ -f .gitignore ]; then
            echo "âœ… .gitignore exists" >> git-report.md
            
            # Check for common patterns
            if grep -q "node_modules" .gitignore; then
              echo "âœ… Ignores node_modules" >> git-report.md
            else
              echo "âš ï¸ Doesn't ignore node_modules" >> git-report.md
            fi
            
            if grep -q "\.env" .gitignore; then
              echo "âœ… Ignores .env files" >> git-report.md
            else
              echo "âš ï¸ Doesn't ignore .env files" >> git-report.md
            fi
            
            if grep -q "__pycache__" .gitignore; then
              echo "âœ… Ignores __pycache__" >> git-report.md
            else
              echo "âš ï¸ Doesn't ignore __pycache__" >> git-report.md
            fi
          else
            echo "âŒ No .gitignore found" >> git-report.md
          fi
          
          # Check for large files
          echo "" >> git-report.md
          echo "## Large Files Check:" >> git-report.md
          large_files=$(find . -type f -size +5M | grep -v ".git" | head -10)
          if [ -z "$large_files" ]; then
            echo "âœ… No files larger than 5MB" >> git-report.md
          else
            echo "âš ï¸ Large files found:" >> git-report.md
            echo "$large_files" >> git-report.md
          fi
          
          # Check commit messages
          echo "" >> git-report.md
          echo "## Recent Commit Quality:" >> git-report.md
          git log --oneline -10 >> git-report.md
          
          # Check for sensitive files
          echo "" >> git-report.md
          echo "## Sensitive Files Check:" >> git-report.md
          sensitive=$(find . -name "*.pem" -o -name "*.key" -o -name "*.p12" -o -name "id_rsa*" | grep -v ".git" | head -10)
          if [ -z "$sensitive" ]; then
            echo "âœ… No sensitive key files found" >> git-report.md
          else
            echo "ðŸš¨ CRITICAL: Sensitive files found!" >> git-report.md
            echo "$sensitive" >> git-report.md
          fi
          
          cat git-report.md
        continue-on-error: true

      - name: Upload Git Report
        uses: actions/upload-artifact@v4
        with:
          name: git-hygiene
          path: git-report.md

  # ============================================================================
  # ACCESSIBILITY CHECK
  # ============================================================================
  accessibility-check:
    name: â™¿ Accessibility Check
    runs-on: ubuntu-latest
    if: hashFiles('**/*.html', '**/*.jsx', '**/*.tsx') != ''
    steps:
      - uses: actions/checkout@v4

      - name: Check Accessibility
        run: |
          npm install -g pa11y-ci axe-cli
          
          echo "# Accessibility Report" > a11y-report.md
          echo "" >> a11y-report.md
          
          # Check for alt text in images
          echo "## Image Accessibility:" >> a11y-report.md
          images_without_alt=$(grep -rn "<img" --include="*.html" --include="*.jsx" --include="*.tsx" . | grep -v "alt=" | wc -l)
          if [ $images_without_alt -eq 0 ]; then
            echo "âœ… All images have alt attributes" >> a11y-report.md
          else
            echo "âš ï¸ Found $images_without_alt images without alt attributes" >> a11y-report.md
          fi
          
          # Check for semantic HTML
          echo "" >> a11y-report.md
          echo "## Semantic HTML:" >> a11y-report.md
          divs=$(grep -r "<div" --include="*.html" --include="*.jsx" --include="*.tsx" . | wc -l)
          semantic=$(grep -rE "<(header|nav|main|article|section|aside|footer)" --include="*.html" --include="*.jsx" --include="*.tsx" . | wc -l)
          echo "Divs found: $divs" >> a11y-report.md
          echo "Semantic elements found: $semantic" >> a11y-report.md
          
          # Check for ARIA labels
          echo "" >> a11y-report.md
          echo "## ARIA Usage:" >> a11y-report.md
          aria_labels=$(grep -r "aria-label" --include="*.html" --include="*.jsx" --include="*.tsx" . | wc -l)
          echo "ARIA labels found: $aria_labels" >> a11y-report.md
          
          cat a11y-report.md
        continue-on-error: true

      - name: Upload Accessibility Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility
          path: a11y-report.md

  # ============================================================================
  # COMPLIANCE SUMMARY
  # ============================================================================
  compliance-summary:
    name: ðŸ“Š Compliance Summary
    needs: [license-compliance, code-style, documentation-check, git-hygiene, accessibility-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Compliance Summary
        run: |
          echo "# âœ… Compliance & Best Practices Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… License Compliance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Style & Formatting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation Quality" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git Hygiene" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Accessibility (if applicable)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **Review artifacts for detailed compliance reports**" >> $GITHUB_STEP_SUMMARY
