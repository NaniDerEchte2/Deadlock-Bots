name: "âœ… Compliance Check (Optimized)"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ============================================================================
  # DOCUMENTATION CHECK (ALWAYS RUNS)
  # ============================================================================
  documentation:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Check Essential Documentation
        run: |
          echo "# Documentation Quality" > docs-report.md
          echo "" >> docs-report.md
          echo "## Essential Files:" >> docs-report.md
          
          # README
          if [ -f README.md ]; then
            lines=$(wc -l < README.md)
            echo "âœ… README.md exists ($lines lines)" >> docs-report.md
          else
            echo "âŒ README.md missing" >> docs-report.md
          fi
          
          # LICENSE
          if [ -f LICENSE ] || [ -f LICENSE.md ] || [ -f LICENSE.txt ]; then
            echo "âœ… LICENSE file exists" >> docs-report.md
          else
            echo "âš ï¸ LICENSE file missing" >> docs-report.md
          fi
          
          # CONTRIBUTING
          if [ -f CONTRIBUTING.md ] || [ -f .github/CONTRIBUTING.md ]; then
            echo "âœ… CONTRIBUTING guide exists" >> docs-report.md
          else
            echo "â„¹ï¸ CONTRIBUTING guide not found" >> docs-report.md
          fi
          
          # Security Policy
          if [ -f SECURITY.md ] || [ -f .github/SECURITY.md ]; then
            echo "âœ… Security policy exists" >> docs-report.md
          else
            echo "â„¹ï¸ Security policy not found" >> docs-report.md
          fi
          
          cat docs-report.md

      - name: Upload Documentation Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: documentation-check
          path: docs-report.md
          if-no-files-found: ignore

  # ============================================================================
  # GIT HYGIENE (ALWAYS RUNS)
  # ============================================================================
  git-hygiene:
    name: ðŸ”€ Git Hygiene
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check Git Best Practices
        run: |
          echo "# Git Hygiene Report" > git-report.md
          echo "" >> git-report.md
          
          # .gitignore
          echo "## .gitignore Check:" >> git-report.md
          if [ -f .gitignore ]; then
            echo "âœ… .gitignore exists" >> git-report.md
            
            # Common patterns
            [ -n "$(grep 'node_modules' .gitignore 2>/dev/null)" ] && echo "âœ… Ignores node_modules" >> git-report.md || echo "â„¹ï¸ Add node_modules to .gitignore" >> git-report.md
            [ -n "$(grep '\.env' .gitignore 2>/dev/null)" ] && echo "âœ… Ignores .env" >> git-report.md || echo "âš ï¸ Add .env to .gitignore" >> git-report.md
            [ -n "$(grep '__pycache__' .gitignore 2>/dev/null)" ] && echo "âœ… Ignores __pycache__" >> git-report.md || echo "â„¹ï¸ Add __pycache__ to .gitignore" >> git-report.md
          else
            echo "âš ï¸ No .gitignore found" >> git-report.md
          fi
          
          # Large files
          echo "" >> git-report.md
          echo "## Large Files (>5MB):" >> git-report.md
          large=$(find . -type f -size +5M 2>/dev/null | grep -v ".git" | head -5)
          if [ -z "$large" ]; then
            echo "âœ… No large files" >> git-report.md
          else
            echo "âš ï¸ Large files found:" >> git-report.md
            echo "$large" >> git-report.md
          fi
          
          # Sensitive files
          echo "" >> git-report.md
          echo "## Sensitive Files Check:" >> git-report.md
          sensitive=$(find . \( -name "*.pem" -o -name "*.key" -o -name "*.p12" -o -name "id_rsa*" \) 2>/dev/null | grep -v ".git" | head -5)
          if [ -z "$sensitive" ]; then
            echo "âœ… No sensitive files" >> git-report.md
          else
            echo "ðŸš¨ CRITICAL: Sensitive files found!" >> git-report.md
            echo "$sensitive" >> git-report.md
          fi
          
          cat git-report.md

      - name: Upload Git Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: git-hygiene
          path: git-report.md
          if-no-files-found: ignore

  # ============================================================================
  # CODE STYLE (PYTHON ONLY IF EXISTS)
  # ============================================================================
  python-style:
    name: ðŸŽ¨ Python Code Style
    runs-on: ubuntu-latest
    if: hashFiles('**/*.py') != ''
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Check Python Style
        run: |
          pip install black ruff
          
          echo "# Python Style Report" > python-style.md
          echo "" >> python-style.md
          
          # Black
          echo "## Black Formatting:" >> python-style.md
          if black --check . 2>&1; then
            echo "âœ… Code is formatted" >> python-style.md
          else
            echo "âš ï¸ Code needs formatting" >> python-style.md
          fi
          
          # Ruff
          echo "" >> python-style.md
          echo "## Ruff Linting:" >> python-style.md
          ruff check . --output-format=text >> python-style.md 2>&1 || echo "Issues found" >> python-style.md
          
          cat python-style.md
        continue-on-error: true

      - name: Upload Style Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: python-style
          path: python-style.md
          if-no-files-found: ignore

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: ðŸ“Š Compliance Summary
    needs: [documentation, git-hygiene, python-style]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "# âœ… Compliance & Best Practices Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Git Hygiene: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Python Style: ${{ needs.python-style.result == 'success' && 'âœ…' || needs.python-style.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY
