Hier ist eine kompakte, aber vollstÃ¤ndige Doku/README fÃ¼r den **TempVoice**-Ordner. Du kannst den Text 1:1 als `cogs/tempvoice/README.md` ablegen.

---

# TempVoice â€“ Auto-Lanes + UI (DE/EU, MinRank, Owner-Claim, Kick/Ban)

Dieses Paket stellt ein schlankes, DB-zentriertes System fÃ¼r temporÃ¤re Voice-â€Lanesâ€œ bereit.
Es besteht aus zwei Cogs, die zusammen als **eine Extension** `cogs.tempvoice` geladen werden:

* **Core (Logik & Persistenz)**: Auto-Erstellung, Owner-Handling, Bans, Region-Filter, MinRank, Purge.
* **Interface (UI)**: Persistente Buttons/Selects im festen Textkanal (keine Text-Commands).

Die zentrale DB (`shared.db`) wird Ã¼ber `utils.deadlock_db.DB_PATH` verwendet.
Keine eigene DB-Schicht auÃŸerhalb davon.

---

## Verzeichnisstruktur

```
cogs/tempvoice/
â”œâ”€ __init__.py      # Orchestriert die Cogs â€“ lÃ¤dt Core und Interface in richtiger Reihenfolge
â”œâ”€ core.py          # GeschÃ¤ftslogik: Auto-Lanes, Owner, Bans, Region, MinRank, Purge, DB
â””â”€ interface.py     # UI: Buttons/Selects/Modal, persistente Panel-Message, ruft Core-APIs
```

> **Hinweis zu `util.py`:**
> In der aktuellen Aufteilung liegen alle â€einzigen Wahrheitenâ€œ (IDs, Tabellen, Kernlogik) im **Core**.
> Ein separates `util.py` ist nicht nÃ¶tig; falls es existiert, enthÃ¤lt es nur leichte Helfer ohne Logik.

---

## Was macht welches Script?

### `__init__.py` (Extension-Setup)

* Exportiert **eine** Extension `cogs.tempvoice` fÃ¼r den Master-Loader.
* Erzeugt **zuerst** `TempVoiceCore`, Ã¼bergibt ihn anschlieÃŸend an `TempVoiceInterface`, damit die UI auf Core-Methoden zugreifen kann.
* Registriert beide Cogs beim Bot.

### `core.py` â€“ **TempVoiceCore**

**Aufgaben:**

* **Auto-Lane**: Beim Join in einen der **Staging-Channels** wird eine Lane erstellt, der Nutzer rÃ¼ber gemoved und in der DB erfasst.
* **Persistenz (DB)**:
  Tabellen:

  * `tempvoice_lanes(channel_id, guild_id, owner_id, base_name, category_id, created_at)`
  * `tempvoice_bans(owner_id, banned_id, created_at)`
  * `tempvoice_interface(guild_id, channel_id, message_id, updated_at)` *(vom Interface genutzt)*
  * `tempvoice_owner_prefs(owner_id, region, updated_at)` *(DE/EU-PrÃ¤ferenz pro Owner)*
* **Owner-Handling**:

  * Beim Verlassen des Owners geht die Lane an den **am lÃ¤ngsten anwesenden** Member.
  * **Owner-Claim**: Button in der UI Ã¼bertrÃ¤gt den Owner sofort an den Klicker (kein Timer).
* **Region-Filter (DE/EU)**:

  * Speichert **persÃ¶nliche PrÃ¤ferenz** (DE/EU) des Nutzers in `tempvoice_owner_prefs`.
  * Wendet bei Lane-Erstellung die PrÃ¤ferenz des Owners automatisch an.
  * Setzt/entfernt `connect`-Overwrites fÃ¼r die Rolle **â€English Onlyâ€œ** (ID konfiguriert).
* **MinRank**:

* **Nur** in den freigegebenen Kategorien aktiv (`MINRANK_CATEGORY_IDS`).
  * Setzt `connect=False` fÃ¼r zu niedrige Rank-Rollen, lÃ¶scht Overwrites bei â€Kein Limitâ€œ.
* **Kick/Ban/Unban**:

  * **Ban** ist â€Owner-lokalâ€œ: Owner â†’ viele gebannte User (in `tempvoice_bans`).
  * Beim Betreten der Lane wird ein gebannter User in einen Staging-Channel verschoben (Soft-Enforce).
  * Resolver akzeptiert `@Mention`, **ID** und **exakten Namen** (Case-insensitiv).
* **Purge & Rehydration**:

  * Beim Start: DB-EintrÃ¤ge laden (**Rehydrate**).
  * **Purge** leerer Lanes: sofort & verzÃ¶gert (zweiter Sweep), inkl. Entfernen verwaister DB-Zeilen.
* **Sichere Channel-Edits**: Locking + Cooldown, damit Namen/Limits nicht 429-anfÃ¤llig sind.

**Wichtige Ã¶ffentliche Methoden (vom Interface genutzt):**

* `parse_user_identifier(guild, raw) -> Optional[int]`
  (Ermittelt User-ID aus @, ID, Name)
* `set_region_pref(owner_id, region) / get_region_pref(owner_id) / apply_region(lane, region)`
  (PrÃ¤ferenz sichern/lesen, Overwrites setzen)
* `transfer_owner(lane, member_id)`
  (Sofortiger Owner-Transfer)
* `safe_edit_channel(lane, desired_name?, desired_limit?, reason?)`
  (Rate-begrenzte, threadsichere Channel-Edits)
* `refresh_name(lane)`
  (Titel neu zusammensetzen & anwenden)
* `db` / `first_guild()`
  (gezielter Zugriff fÃ¼r Interface-Funktionen)

**Konfigurations-Konstanten (oben in `core.py`):**

* `STAGING_CHANNEL_IDS`: Menge aller Staging-Voice-Channel-IDs
* `MINRANK_CATEGORY_IDS`: Kategorien, in denen MinRank aktiv ist
* `RANKED_CATEGORY_ID`: (fÃ¼r Defaults pro Kategorie)
* `INTERFACE_TEXT_CHANNEL_ID`: Textkanal, in den das Interface gepostet wird
* `ENGLISH_ONLY_ROLE_ID`: Rolle, die fÃ¼r â€Deutsch-Onlyâ€œ gesperrt wird
* `DEFAULT_CASUAL_CAP` / `DEFAULT_RANKED_CAP`: Standard-Userlimits
* `RANK_ORDER`: Reihenfolge der RÃ¤nge (Name = Rollenname in Discord)

### `interface.py` â€“ **TempVoiceInterface**

**Aufgaben:**

* **Persistentes Panel** im Textkanal `INTERFACE_TEXT_CHANNEL_ID`:

  * Speichert `message_id` in `tempvoice_interface`, editiert bei Neustart statt neu zu posten.
* **UI-View mit Buttons/Selects** (keine Text-Commands):

  * **ğŸ‡©ğŸ‡ª DE / ğŸ‡ªğŸ‡º EU**
    Speichert die User-PrÃ¤ferenz (DE/EU) und wendet sie auf die **aktuelle Lane** an.
    â†’ Core: `set_region_pref(...)` + `apply_region(...)`
  * **ğŸšï¸ Limit setzen**
    Modal zur Eingabe (0â€“99), setzt `user_limit`.
    â†’ Core: `safe_edit_channel(... desired_limit=...)`
  * **Mindest-Rang (Select)**
    Nur aktiv, wenn die Lane in `MINRANK_CATEGORY_IDS` liegt.
    â†’ Core: `_apply_min_rank` (intern Ã¼ber `refresh_name`/private APIs)
  * **ğŸ‘¢ Kick**
    Verschiebt gewÃ¤hlten User in den ersten erreichbaren Staging-Channel.
  * **ğŸš« Ban / â™»ï¸ Unban**
    Ban/Unban per @/ID/Name (Resolver im Core).
    Ban: `connect=False` + optionaler Move in Staging, DB-Persistenz in `tempvoice_bans`.
  * **ğŸ‘‘ Owner Claim**
    Sofortiger Transfer des Owner-Status an den Klicker.
    â†’ Core: `transfer_owner(...)`
* **Berechtigungslogik**:
  FÃ¼r sensitive Aktionen (Region wechseln, Limit, Kick/Ban/Unban) gilt:

  * Erlaubt, wenn **Owner** der Lane **oder** `manage_channels` **oder** `administrator`.

---

## Ereignisfluss (End-to-End)

1. **Join** eines Nutzers in **Staging**
   â†’ `on_voice_state_update` (Core) erkennt Staging â†’ `_create_lane(...)`
   â†’ VoiceChannel wird erstellt, der Nutzer wird gemoved, Lane wird in DB gespeichert
   â†’ Owner-PrÃ¤ferenz (DE/EU) wird sofort angewendet
   â†’ Owner-Bans werden als Overwrites gesetzt
   â†’ Name aktualisiert (MinRank-Suffix nur in Spezial-Kategorie)

2. **Owner verlÃ¤sst die Lane**
   â†’ LÃ¤ngste Anwesenheit bestimmt neuen Owner (DB-Update).
   â†’ Wenn Lane **leer** â†’ Channel lÃ¶schen + DB-Zeile lÃ¶schen.

3. **UI-Interaktionen**

   * Region-Button â†’ PrÃ¤ferenz speichern + Overwrites setzen
   * Limit-Modal â†’ Limit einstellen
   * MinRank-Select â†’ nur in Spezial-Kategorie wirksam
   * Kick/Ban/Unban â†’ Move-to-Staging bzw. Overwrites + DB-Persistenz
   * Owner-Claim â†’ sofortiger Transfer

4. **Neustart des Bots**

   * Interface findet/editiert die bestehende Panel-Message (per DB)
   * Core **rehydriert** alle Lanes aus DB
   * **Purge** alle **leeren** Lanes (inkl. Fallback-Sweep)
   * Verwaiste DB-Zeilen werden bereinigt

---

## Berechtigungen & Voraussetzungen

* **Bot-Intents**: `members`, `voice_states`, `guilds`, `message_content` (optional fÃ¼r Logging)
* **Bot-Rechte**:

  * *Manage Channels* (Voice erstellen/Ã¤ndern, Overwrites setzen)
  * *Move Members* (Kick = Move in Staging)
* **Rolle â€English Onlyâ€œ** (ID: `ENGLISH_ONLY_ROLE_ID`) muss existieren.
* **Konfiguration** der IDs oben in `core.py` prÃ¼fen/anpassen:

  * `STAGING_CHANNEL_IDS`, `MINRANK_CATEGORY_IDS`, `INTERFACE_TEXT_CHANNEL_ID`, `ENGLISH_ONLY_ROLE_ID`

---

## Quickstart

1. IDs in `core.py` setzen.
2. Bot starten â€“ `main_bot.py` lÃ¤dt `cogs.tempvoice` automatisch (Auto-Discovery).
3. **Staging** beitreten â†’ Lane wird erstellt, DE/EU PrÃ¤ferenz angewandt.
4. **Interface-Buttons** im Textkanal nutzen:

   * ğŸ‡©ğŸ‡ª/ğŸ‡ªğŸ‡º, ğŸšï¸ Limit, ğŸ‘‘ Owner Claim, ğŸ‘¢ Kick, ğŸš« Ban, â™»ï¸ Unban, MinRank (nur Special-Kategorie).
5. Neustart testen â†’ Leere Lanes werden weggerÃ¤umt; Panel bleibt erhalten.

---

## Erweiterbarkeit

* **Neue UI-Aktionen**: In `interface.py` als Button/Modal/Select ergÃ¤nzen und Ã¼ber die **Ã¶ffentlichen Core-Methoden** arbeiten.
* **Neue Policies** (z. B. weitere Filter): Im **Core** implementieren und als schlanke Fassade (Wrapper) bereitstellen â€“ das Interface bleibt dÃ¼nn.
* **Weitere Persistenz**: Neue, kleine Tabellen im Core (`TVDB._create_tables`) hinzufÃ¼gen. Keine separate DB-Logik streuen.

---

## Troubleshooting

* **Interface: Textkanal nicht gefunden**
  â†’ `INTERFACE_TEXT_CHANNEL_ID` prÃ¼fen (muss ein **TextChannel** sein).
* **DE/EU tut nichts**
  â†’ Rolle â€English Onlyâ€œ existiert? Bot hat *Manage Channels*?
* **Ban via `@`/Name** funktioniert nicht
  â†’ Exakte Schreibweise nÃ¶tig. Bei Mehrdeutigkeit wird abgebrochen. (Optional: Fuzzy-Resolver nachrÃ¼stbar.)
* **Purge nach Neustart greift nicht**
  â†’ PrÃ¼fe, ob der Channel wirklich **leer** ist und ob der Bot *Manage Channels* hat.

---

## Design-Prinzipien

* **Eine Quelle der Wahrheit** (Core): Alle Regeln & IDs zentral.
* **UI ist dÃ¼nn**: Buttons rufen Core-Methoden auf, kein â€zweites Gehirnâ€œ im Interface.
* **DB-first**: Rehydration + Purge sichern konsistenten Zustand Ã¼ber Neustarts.
* **Rate-safe**: Edit-Locks & Cooldown vermeiden 429.

---

Wenn du willst, packe ich dir das als fertige `README.md` in Markdown mit Emojis/Badges â€“ sag Bescheid und ich formatiere dir das exakt fÃ¼r dein Repo.
